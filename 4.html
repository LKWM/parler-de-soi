<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parler de soi - Leçon 4</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');

        :root {
            --unit: 1vmin; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .korean-text {
            font-family: 'Noto Sans KR', sans-serif;
        }

        #app-container {
            background-color: white;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        /* Desktop: 16:9 Ratio */
        @media (min-width: 1024px) {
            #app-container {
                aspect-ratio: 16/9;
                width: auto;
                height: 100vh;
                max-width: 177.78vh;
                box-shadow: 0 0 50px rgba(0,0,0,0.5);
            }
            html { font-size: 2.5vh; } 
        }

        /* Mobile */
        @media (max-width: 1023px) {
            #app-container {
                width: 100%;
                height: 100%;
            }
            html { font-size: 16px; }
        }

        .page-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: clamp(2vh, 4vmin, 4vh) clamp(2vw, 4vmin, 4vw);
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .card-box {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            padding: clamp(1.5rem, 4vmin, 3rem);
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex-shrink: 1;
            max-height: 100%;
            overflow-y: auto;
        }

        .text-fluid-xl { font-size: clamp(1.5rem, 5vmin, 4rem); }
        .text-fluid-lg { font-size: clamp(1.2rem, 3.5vmin, 2.5rem); }
        .text-fluid-base { font-size: clamp(1rem, 2.5vmin, 1.5rem); }
        .text-fluid-sm { font-size: clamp(0.875rem, 2vmin, 1.25rem); }
        .icon-fluid-md { font-size: clamp(1.5rem, 4vmin, 3rem); }
        .icon-fluid-lg { font-size: clamp(2rem, 6vmin, 5rem); }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .nav-btn {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        @media (min-width: 1024px) {
            .nav-btn { width: 5rem; height: 5rem; }
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="header" class="absolute top-0 right-0 p-4 md:p-6 z-20 hidden">
        <span id="page-indicator" class="font-mono text-gray-400 font-bold text-fluid-sm bg-gray-100 px-3 py-1 rounded-full">1 / 19</span>
    </div>

    <div id="content-area" class="flex-grow flex flex-col items-center justify-center w-full h-full relative text-center"></div>

    <div id="footer" class="absolute bottom-0 w-full p-6 md:p-8 flex justify-between items-end z-20 pointer-events-none hidden">
        <button id="btn-prev" class="nav-btn bg-gray-100 text-gray-500 hover:bg-gray-200 pointer-events-auto">
            <i class="ph ph-arrow-left icon-fluid-md"></i>
        </button>
        <button id="btn-next" class="nav-btn bg-indigo-600 text-white hover:bg-indigo-700 pointer-events-auto">
            <i class="ph ph-arrow-right icon-fluid-md"></i>
        </button>
    </div>
</div>

<script>
    // --- Configuration ---
    const BASE_44_ORIGIN = "https://coreeno.base44.app"; 
    const CLOVA_API_FUNCTION_URL = BASE_44_ORIGIN + '/api/functions/naverClovaSpeech';
    
    // Audio Resources
    const AUDIO = {
        JOB: "https://res.cloudinary.com/de76i94ia/video/upload/v1767087410/%E1%84%8C%E1%85%B5%E1%86%A8%E1%84%8B%E1%85%A5%E1%86%B8_eov0j6.mp3", // 직업
        JOB_PARTICLE: "https://res.cloudinary.com/de76i94ia/video/upload/v1767088635/%E1%84%8C%E1%85%B5%E1%86%A8%E1%84%8B%E1%85%A5%E1%86%B8%E1%84%8B%E1%85%B5_rogeue.mp3", // 직업이
        WHAT: "https://res.cloudinary.com/de76i94ia/video/upload/v1766933257/%E1%84%86%E1%85%AF%E1%84%8B%E1%85%A8%E1%84%8B%E1%85%AD_mowaek.mp3", // 뭐예요
        Q_JOB: "https://res.cloudinary.com/de76i94ia/video/upload/v1767087382/sentence_1_vbijvz.mp3", // 직업이 뭐예요?
        DOCTOR: "https://res.cloudinary.com/de76i94ia/video/upload/v1767087383/%E1%84%8B%E1%85%B4%E1%84%89%E1%85%A1_xrumqs.mp3", // 의사
        AM_DOCTOR: "https://res.cloudinary.com/de76i94ia/video/upload/v1767087383/sentence_2_yhhdyr.mp3", // 저는 의사예요
        STUDENT: "https://res.cloudinary.com/de76i94ia/video/upload/v1767088635/%E1%84%92%E1%85%A1%E1%86%A8%E1%84%89%E1%85%A2%E1%86%BC_weyhie.mp3", // 학생
        AM_STUDENT: "https://res.cloudinary.com/de76i94ia/video/upload/v1767087383/sentence_3_ec5vgm.mp3", // 저는 학생이에요
        
        EXP_1: "https://res.cloudinary.com/de76i94ia/video/upload/v1767088645/audio_1_qctm3c.mp3",
        EXP_2: "https://res.cloudinary.com/de76i94ia/video/upload/v1767088646/audio_2_tcxddp.mp3",
        EXP_3: "https://res.cloudinary.com/de76i94ia/video/upload/v1767088646/audio_3_hcnrmb.mp3",
        EXP_4: "https://res.cloudinary.com/de76i94ia/video/upload/v1767088647/audio_4_xssvbd.mp3",
        EXP_5: "https://res.cloudinary.com/de76i94ia/video/upload/v1767088648/audio_5_vkmzoc.mp3",
        EXP_6: "https://res.cloudinary.com/de76i94ia/video/upload/v1767093704/audio_6_ew2eij.mp3"
    };

    const pages = [
        {
            type: 'cover',
            title: "Chapitre 2: Demander et dire son métier",
            subtitle: "Leçon 4 : Comment demander et dire son métier",
            buttonText: "Commencer"
        },
        // Page 1: Text
        {
            type: 'text',
            text: "Bonjour ! Bienvenue dans le chapitre 2. Dans cette leçon, nous allons apprendre les expressions pour demander et dire le métier.",
            audio: AUDIO.EXP_1
        },
        // Page 2: Card Audio (직업)
        {
            type: 'card_audio',
            mainText: "<span class='text-blue-600'>직업</span>",
            sub1: "", 
            sub2: "Métier",
            text: "“직업” désigne le travail que l'on fait pour gagner sa vie. Généralement, cela signifie un travail rémunéré, mais cela peut aussi désigner une activité régulière non rémunérée, comme être étudiant ou femme ou homme au foyer.",
            audio: AUDIO.EXP_2, 
            cardAudio: AUDIO.JOB
        },
        // Page 3: Repeat (직업)
        {
            type: 'repeat',
            instruction: "Répétez après moi.",
            mainText: "<span class='text-blue-600'>직업</span>",
            sub1: "", 
            sub2: "Métier",
            referenceText: "직업",
            attempts: 3,
            cardAudio: AUDIO.JOB
        },
        // Page 4: Card Audio (직업이)
        {
            type: 'card_audio',
            mainText: "<span class='text-blue-600'>직업</span><span class='text-rose-500'>이</span>",
            sub1: "<span class='text-blue-600'>Métier</span> + <span class='text-rose-500'>particule de sujet</span>",
            sub2: "Métier",
            text: "Comme en français, les phrases en coréen commencent par le sujet. On ajoute la particule “이” après un sujet qui se termine par une consonne.",
            audio: AUDIO.EXP_3,
            cardAudio: AUDIO.JOB_PARTICLE
        },
        // Page 5: Repeat (뭐예요)
        {
            type: 'repeat',
            instruction: "Répétez après moi.",
            mainText: "<span class='text-blue-600'>뭐</span><span class='text-rose-500'>예요</span>",
            sub1: "<span class='text-blue-600'>Quoi</span> <span class='text-rose-500'>être</span>",
            sub2: "Que’est-ce que",
            referenceText: "뭐예요",
            attempts: 3,
            cardAudio: AUDIO.WHAT
        },
        // Page 6: Repeat (직업이 뭐예요?) - Updated Colors Correctly
        {
            type: 'repeat',
            instruction: "Maintenant, combinons ces deux parties pour poser la question.",
            mainText: "<span class='text-blue-600'>직업</span>이 <span class='text-red-600'>뭐</span><span class='text-green-600'>예요</span>?",
            sub1: "<span class='text-red-600'>Quel</span> <span class='text-green-600'>est</span> votre <span class='text-blue-600'>métier</span> ?",
            sub2: "Quel est votre métier ?",
            referenceText: "직업이 뭐예요",
            attempts: 3,
            cardAudio: AUDIO.Q_JOB
        },
        // Page 7: Repeat (직업이 뭐예요? - Again) - Updated Colors Correctly
        {
            type: 'repeat',
            instruction: "Essayez encore une fois.",
            mainText: "<span class='text-blue-600'>직업</span>이 <span class='text-red-600'>뭐</span><span class='text-green-600'>예요</span>?",
            sub1: "<span class='text-red-600'>Quel</span> <span class='text-green-600'>est</span> votre <span class='text-blue-600'>métier</span> ?",
            sub2: "Quel est votre métier ?",
            referenceText: "직업이 뭐예요",
            attempts: 3,
            cardAudio: AUDIO.Q_JOB
        },
        // Page 8: Repeat (의사)
        {
            type: 'repeat',
            instruction: "Répétez après moi.",
            mainText: "<span class='text-blue-600'>의사</span>",
            sub1: "", 
            sub2: "Médecin",
            referenceText: "의사",
            attempts: 3,
            cardAudio: AUDIO.DOCTOR
        },
        // Page 9: Card Audio (저는 의사예요)
        {
            type: 'card_audio',
            mainText: "저는 <span class='text-blue-600'>의사</span><span class='text-rose-500'>예요</span>.",
            sub1: "Je <span class='text-rose-500'>suis</span> <span class='text-blue-600'>médecin</span>.",
            sub2: "Je suis médecin.",
            text: "Comme nous l'avons fait pour dire le nom, \"이다\" ,qui signifie \"être\", doit toujours être conjugué. Si le dernier caractère du complément du sujet se termine par une voyelle, on le conjugue en \"예요\".",
            audio: AUDIO.EXP_4,
            cardAudio: AUDIO.AM_DOCTOR
        },
        // Page 10: Repeat (저는 의사예요)
        {
            type: 'repeat',
            instruction: "Répétez après moi.",
            mainText: "저는 <span class='text-blue-600'>의사</span><span class='text-rose-500'>예요</span>.",
            sub1: "Je <span class='text-rose-500'>suis</span> <span class='text-blue-600'>médecin</span>.",
            sub2: "Je suis médecin.",
            referenceText: "저는 의사예요",
            attempts: 3,
            cardAudio: AUDIO.AM_DOCTOR
        },
        // Page 11: Repeat (학생)
        {
            type: 'repeat',
            instruction: "Répétez après moi.",
            mainText: "<span class='text-blue-600'>학생</span>",
            sub1: "", 
            sub2: "Étudiant(e)",
            referenceText: "학생",
            attempts: 3,
            cardAudio: AUDIO.STUDENT
        },
        // Page 12: Card Audio (저는 학생이에요)
        {
            type: 'card_audio',
            mainText: "<span class='text-blue-600'>저</span>는 <span class='text-red-600'>학생</span><span class='text-green-600'>이에요</span>.", 
            sub1: "<span class='text-blue-600'>Je</span> <span class='text-green-600'>suis</span> <span class='text-red-600'>étudiant(e)</span>.",
            sub2: "Je suis étudiant(e).",
            text: "Si le dernier caractère du complément du sujet se termine par une consonne, \"이다\" se conjugue en \"이에요\".",
            audio: AUDIO.EXP_5,
            cardAudio: AUDIO.AM_STUDENT
        },
        // Page 13: Repeat (저는 학생이에요)
        {
            type: 'repeat',
            instruction: "Répétez après moi.",
            mainText: "<span class='text-blue-600'>저</span>는 <span class='text-red-600'>학생</span><span class='text-green-600'>이에요</span>.",
            sub1: "<span class='text-blue-600'>Je</span> <span class='text-green-600'>suis</span> <span class='text-red-600'>étudiant(e)</span>.",
            sub2: "Je suis étudiant(e).",
            referenceText: "저는 학생이에요",
            attempts: 3,
            cardAudio: AUDIO.AM_STUDENT
        },
        // Page 14: Repeat (직업이 뭐예요? - Recap)
        {
            type: 'repeat',
            instruction: "Bravo ! Maintenant, demandez le métier encore une fois.",
            mainText: "직업이 뭐예요?",
            sub1: "",
            sub2: "Quel est votre métier ?",
            referenceText: "직업이 뭐예요",
            attempts: 3,
            cardAudio: AUDIO.Q_JOB
        },
        // Page 15: Quiz Speak
        {
            type: 'quiz_speak',
            instruction: "À vous de le dire !",
            mainText: "Quel est votre métier ?",
            hint: "(직업이 뭐예요? 라고 말해야 통과)",
            referenceText: "직업이 뭐예요",
            hiddenHint: true
        },
        // Page 16: Quiz Response (의사)
        {
            type: 'quiz_response',
            instruction: "Cette fois, répondez à la question.",
            audioPrompt: AUDIO.Q_JOB, 
            mainText: "Je suis médecin.",
            subKorean: "", 
            referenceText: "저는 의사예요",
            hintAudio: AUDIO.AM_DOCTOR // HINT ADDED
        },
        // Page 17: Quiz Response (학생)
        {
            type: 'quiz_response',
            instruction: "Répondez à la question.",
            audioPrompt: AUDIO.Q_JOB,
            mainText: "Je suis étudiant(e).",
            subKorean: "", 
            referenceText: "저는 학생이에요",
            hintAudio: AUDIO.AM_STUDENT // HINT ADDED
        },
        // Page 18: Outro
        {
            type: 'outro',
            text: "C'est tout pour aujourd'hui ! Entraînez-vous davantage avec les expressions apprises aujourd'hui dans les leçons 5 à 7 ! À bientôt !",
            audio: AUDIO.EXP_6
        }
    ];

    // --- Audio & State ---
    let currentPage = 0;
    let audioContextInitialized = false;
    let correctSound, completionSynth, pageTurnSynth;
    let currentAudioObj = null;
    let autoPlayTimer = null;
    const pageStates = {}; 

    async function initAudio() {
        if (audioContextInitialized) return;
        try {
            await Tone.start();
            correctSound = new Tone.Synth().toDestination();
            completionSynth = new Tone.PolySynth(Tone.Synth).toDestination();
            pageTurnSynth = new Tone.MembraneSynth({
                pitchDecay: 0.008, octaves: 1, oscillator: { type: 'sine' },
                envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
            }).toDestination();
            audioContextInitialized = true;
        } catch (e) {
            console.warn("Audio init failed", e);
        }
    }

    function playSound(type) {
        if (!audioContextInitialized) return;
        switch (type) {
            case 'correct': correctSound.triggerAttackRelease('C5', '0.1s'); break;
            case 'turn': pageTurnSynth.triggerAttackRelease("C2", "32n"); break;
            case 'complete': completionSynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "4n"); break;
        }
    }

    function stopCurrentAudio() {
        if (autoPlayTimer) { clearTimeout(autoPlayTimer); autoPlayTimer = null; }
        if (currentAudioObj) {
            currentAudioObj.pause();
            currentAudioObj.currentTime = 0;
            currentAudioObj.onended = null;
            currentAudioObj = null;
        }
    }

    function playAudio(src) {
        stopCurrentAudio();
        if (!src) return;
        currentAudioObj = new Audio(src);
        currentAudioObj.play().catch(e => { if(!e.message.includes('interrupted')) console.error("Play error:", e); });
    }

    // --- UI Logic ---
    const container = document.getElementById('content-area');
    const header = document.getElementById('header');
    const footer = document.getElementById('footer');
    const pageIndicator = document.getElementById('page-indicator');
    const btnNext = document.getElementById('btn-next');
    const btnPrev = document.getElementById('btn-prev');

    function renderPage() {
        stopCurrentAudio();
        stopRecording(null, true); 

        container.innerHTML = '';
        const page = pages[currentPage];
        
        if (!pageStates[currentPage]) pageStates[currentPage] = { attemptsUsed: 0, passed: false };

        pageIndicator.innerText = `${currentPage + 1} / ${pages.length}`;
        
        if (page.type === 'cover') {
            header.classList.add('hidden');
            footer.classList.add('hidden');
        } else {
            header.classList.remove('hidden');
            footer.classList.remove('hidden');
        }

        btnPrev.disabled = currentPage <= 1;
        btnPrev.classList.toggle('opacity-0', currentPage <= 1);
        
        resetNextButton();
        
        switch(page.type) {
            case 'cover': renderCover(page); break;
            case 'text': renderTextPage(page); break;
            case 'card_audio': renderCardAudio(page); break;
            case 'repeat': renderRepeat(page); break;
            case 'quiz_speak': renderQuizSpeak(page); break;
            case 'quiz_response': renderQuizResponse(page); break;
            case 'outro': renderOutro(page); break;
        }

        checkPageState(page);
    }

    function resetNextButton() {
        btnNext.disabled = false;
        btnNext.classList.remove('bg-gray-400', 'cursor-not-allowed');
        btnNext.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        btnNext.innerHTML = `<i class="ph ph-arrow-right icon-fluid-md"></i>`;
    }

    function disableNextButton() {
        btnNext.disabled = true;
        btnNext.classList.add('bg-gray-400', 'cursor-not-allowed');
        btnNext.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    }

    function checkPageState(page) {
        if (['cover', 'text', 'card_audio', 'outro'].includes(page.type)) return;
        
        const state = pageStates[currentPage];
        if (state.passed) {
             const feedback = document.getElementById('feedback-msg');
             const recBtn = document.getElementById('rec-btn');
             if(feedback) {
                 if(!feedback.innerHTML.includes("Excellent")) {
                     feedback.insertAdjacentHTML('afterbegin', `<span class="text-green-500 font-bold block mb-1">Excellent !</span>`);
                 }
             }
             if(recBtn) {
                 recBtn.disabled = true;
                 recBtn.innerHTML = `<i class="ph ph-check icon-fluid-md text-green-500"></i>`;
             }
        } else {
            disableNextButton();
            if (state.attemptsUsed >= 3) {
                const feedback = document.getElementById('feedback-msg');
                // Don't show fail message here if we are showing it via processAudio
                // Just enable next button so user isn't stuck
                resetNextButton();
            }
        }
    }

    // --- Renderers ---

    function renderCover(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in text-center">
                <div class="flex flex-col items-center justify-center space-y-[4vh]">
                    <div class="w-[15vh] h-[15vh] bg-indigo-100 rounded-full flex items-center justify-center shadow-inner">
                        <i class="ph ph-chat-circle-text text-[8vh] text-indigo-600"></i>
                    </div>
                    <h1 class="text-fluid-xl font-bold text-gray-800 leading-tight">${page.title}</h1>
                    <p class="text-fluid-lg text-gray-600 font-medium">${page.subtitle}</p>
                    <button onclick="nextPage()" class="mt-[5vh] px-[4vw] py-[2vh] bg-indigo-600 text-white rounded-full font-bold text-fluid-base shadow-lg hover:bg-indigo-700 transition transform hover:scale-105">
                        ${page.buttonText}
                    </button>
                </div>
            </div>
        `;
    }

    function renderTextPage(page) {
        if (page.audio) { autoPlayTimer = setTimeout(() => { playAudio(page.audio); }, 1000); }
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <div class="card-box">
                        <p class="text-fluid-base text-gray-700 leading-relaxed text-center">
                            ${page.text}
                        </p>
                    </div>
                </div>
            </div>
        `;
    }

    function renderCardAudio(page) {
        if (page.audio) { autoPlayTimer = setTimeout(() => { playAudio(page.audio); }, 1000); }
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                 <div class="flex flex-col items-center max-w-4xl w-full gap-[2vh]">
                    <div class="card-box py-[4vh] space-y-[2vh]">
                        <h2 class="text-fluid-xl font-bold text-indigo-900 korean-text">${page.mainText}</h2>
                        <div class="flex flex-col items-center">
                            <span class="subtitle-1 text-fluid-sm">${page.sub1}</span>
                            <span class="subtitle-2 text-fluid-base">${page.sub2}</span>
                        </div>
                        <button onclick="playAudio('${page.cardAudio}')" class="mt-[1vh] w-[8vh] h-[8vh] bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 hover:bg-indigo-100 transition shrink-0 shadow-sm">
                            <i class="ph ph-speaker-high icon-fluid-md"></i>
                        </button>
                    </div>
                    ${page.text ? `
                        <div class="bg-indigo-50/50 p-[3vh] rounded-2xl border border-indigo-100 text-center w-full max-w-[800px]">
                            <p class="text-gray-700 text-fluid-base leading-relaxed">${page.text}</p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    function renderRepeat(page) {
        // No auto-play for cardAudio as requested
        
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    <div class="card-box py-[5vh] space-y-[2vh]">
                        <div class="flex items-center justify-center gap-4">
                            <h2 class="text-fluid-xl font-bold text-indigo-900 korean-text">${page.mainText}</h2>
                            <button onclick="playAudio('${page.cardAudio}')" class="w-[6vh] h-[6vh] bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 hover:bg-indigo-100 transition shadow-sm">
                                <i class="ph ph-speaker-high text-xl"></i>
                            </button>
                        </div>
                        ${page.sub1 ? `<span class="subtitle-1 text-fluid-sm">${page.sub1}</span>` : ''}
                        <span class="subtitle-2 text-fluid-base">${page.sub2}</span>
                    </div>
                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="h-[3vh] text-fluid-sm font-medium text-gray-500">Appuyez pour parler</div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceText, page.attempts);
    }

    function renderQuizSpeak(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[4vh]">
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    <div class="w-full max-w-[800px] bg-indigo-600 p-[5vh] rounded-[2rem] shadow-xl flex flex-col items-center space-y-[2vh] text-white">
                        <i class="ph ph-question icon-fluid-lg opacity-80"></i>
                        <h2 class="text-fluid-lg font-bold leading-snug">${page.mainText}</h2>
                    </div>
                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="h-[3vh] text-fluid-sm font-medium text-gray-500">Appuyez pour répondre</div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceText, 3);
    }

    function renderQuizResponse(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <button onclick="playAudio('${page.audioPrompt}')" class="flex items-center gap-2 px-[3vh] py-[1.5vh] bg-indigo-50 text-indigo-700 rounded-xl text-fluid-sm font-bold hover:bg-indigo-100 transition">
                        <i class="ph ph-speaker-high text-lg"></i> Écouter la question
                    </button>
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    <div class="card-box py-[5vh] space-y-[1.5vh]">
                        <span class="text-fluid-lg font-bold text-gray-800">${page.mainText}</span>
                        ${page.subKorean ? `<span class="text-fluid-base text-indigo-600 korean-text font-medium">${page.subKorean}</span>` : ''}
                    </div>
                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="h-[3vh] text-fluid-sm font-medium text-gray-500">Appuyez pour répondre</div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceText, 3);
    }

    function renderOutro(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center justify-center space-y-[4vh]">
                    <div class="w-[15vh] h-[15vh] bg-green-100 rounded-full flex items-center justify-center mb-4 text-green-600 animate-bounce shadow-lg">
                        <i class="ph ph-check-fat icon-fluid-lg"></i>
                    </div>
                    <h1 class="text-fluid-xl font-bold text-gray-800">Terminé !</h1>
                    <div class="card-box">
                        <p class="text-fluid-base text-gray-600 text-center leading-relaxed">
                            ${page.text}
                        </p>
                    </div>
                </div>
            </div>
        `;
        if (page.audio) { autoPlayTimer = setTimeout(() => { playAudio(page.audio); }, 1500); }
        initAudio().then(() => {
             playSound('complete');
             window.parent.postMessage({ type: 'lesson_complete' }, '*');
        });
        footer.classList.add('hidden');
    }

    // --- Navigation & Helper ---
    function nextPage() {
        initAudio();
        playSound('turn');
        if (currentPage < pages.length - 1) { currentPage++; renderPage(); }
    }
    function prevPage() {
        playSound('turn');
        if (currentPage > 0) { currentPage--; renderPage(); }
    }

    btnNext.addEventListener('click', nextPage);
    btnPrev.addEventListener('click', prevPage);

    // --- Recording Logic ---
    let mediaRecorder, isRecording = false, recordingTimeout;

    async function setupRecording(btnId, feedbackId, referenceText, attemptsMax) {
        const btn = document.getElementById(btnId);
        const feedback = document.getElementById(feedbackId);
        const page = pages[currentPage];
        const state = pageStates[currentPage];

        if (state.passed) { btn.disabled = true; return; }

        btn.onclick = async () => {
            if (attemptsMax && state.attemptsUsed >= attemptsMax && !state.passed) {
                feedback.innerHTML = `<span class="text-orange-500 block mb-1">Nombre de tentatives épuisé.</span>`;
                resetNextButton();
                return;
            }

            if (!isRecording) {
                try {
                    await initAudio(); 
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    const audioChunks = [];
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = async () => {
                            const base64Audio = reader.result.split(',')[1];
                            state.attemptsUsed++;
                            await processAudio(base64Audio, referenceText, feedback, btn);
                        };
                        stream.getTracks().forEach(track => track.stop());
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording-pulse', 'bg-red-500', 'text-white', 'border-red-500');
                    btn.classList.remove('bg-white', 'text-indigo-600', 'border-gray-100');
                    btn.innerHTML = `<i class="ph ph-stop icon-fluid-md"></i>`;
                    feedback.innerText = "Écoute en cours...";
                    recordingTimeout = setTimeout(() => { if (isRecording) stopRecording(btn); }, 10000);
                } catch (err) {
                    console.error("Mic Error:", err);
                    feedback.innerText = "Erreur micro.";
                }
            } else {
                stopRecording(btn);
            }
        };
    }

    function stopRecording(btn, force = false) {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        clearTimeout(recordingTimeout);
        isRecording = false;
        
        if (btn && !force) {
            btn.classList.remove('recording-pulse', 'bg-red-500', 'text-white', 'border-red-500');
            btn.classList.add('bg-white', 'text-indigo-600', 'border-gray-100');
            btn.innerHTML = `<i class="ph ph-microphone icon-fluid-lg"></i>`;
        }
    }

    async function processAudio(audioBase64, referenceText, feedbackEl, btnEl) {
        feedbackEl.innerText = "Analyse...";
        try {
            const payload = { audioBase64: audioBase64, languageCode: "Kor" };
            if (referenceText) payload.referenceText = referenceText;

            const res = await fetch(CLOVA_API_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error("API Error");
            const result = await res.json();
            
            const recognizedText = result.text; 
            let passed = false;
            const score = result.assessment?.pronunciation_score;
            if (referenceText) { if (score >= 80) passed = true; }
            else { if (result.text || score >= 0) passed = true; }

            const state = pageStates[currentPage];
            const displayScore = score !== undefined ? score : '-';
            const page = pages[currentPage];

            let msg = "";
            if (passed) {
                state.passed = true;
                playSound('correct'); 
                msg = `<span class="text-green-500 font-bold block mb-1">Excellent ! (${displayScore})</span>`;
                btnEl.disabled = true;
                btnEl.innerHTML = `<i class="ph ph-check icon-fluid-md text-green-500"></i>`;
                resetNextButton();
            } else {
                if (state.attemptsUsed >= (page.attempts || 3)) {
                     msg = `<span class="text-orange-500 block mb-1">Tentatives épuisées. (${displayScore})</span>`;
                     resetNextButton();
                } else {
                     msg = `<span class="text-orange-500 block mb-1">Réessayez. (${displayScore})</span>`;
                }
            }
            
            // Append transcription for ALL speech interactions
            if (recognizedText) {
                msg += `<div class="text-indigo-600 font-medium mt-1 text-sm">"${recognizedText}"</div>`;
            }

            // Determine hint source (Explicit hintAudio only)
            const hintUrl = page.hintAudio;

            // Show hint if wrong and hint available
            if (!passed && hintUrl) {
                 msg += `<button onclick="playAudio('${hintUrl}')" class="mt-2 flex items-center gap-1 px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs hover:bg-yellow-200 mx-auto transition"><i class="ph ph-speaker-high"></i> Réécouter</button>`;
            }
            
            feedbackEl.innerHTML = msg;

        } catch (e) {
            console.error(e);
            feedbackEl.innerText = "API Error";
            resetNextButton();
        }
    }

    renderPage();
</script>
</body>
</html>
