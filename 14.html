<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parler de soi - Leçon 14</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Hangul.js for Grammar Check -->
    <script src="https://unpkg.com/hangul-js" type="text/javascript"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');

        :root {
            --unit: 1vmin; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .korean-text {
            font-family: 'Noto Sans KR', sans-serif;
        }

        #app-container {
            background-color: white;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        /* Desktop: 16:9 Ratio */
        @media (min-width: 1024px) {
            #app-container {
                aspect-ratio: 16/9;
                width: auto;
                height: 100vh;
                max-width: 177.78vh;
                box-shadow: 0 0 50px rgba(0,0,0,0.5);
            }
            html { font-size: 2.5vh; } 
        }

        /* Mobile */
        @media (max-width: 1023px) {
            #app-container {
                width: 100%;
                height: 100%;
            }
            html { font-size: 16px; }
        }

        .page-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: clamp(2vh, 4vmin, 4vh) clamp(2vw, 4vmin, 4vw);
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .card-box {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            padding: clamp(1.5rem, 4vmin, 3rem);
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex-shrink: 1;
            max-height: 100%;
            overflow-y: auto;
        }

        .text-fluid-xl { font-size: clamp(1.5rem, 5vmin, 4rem); }
        .text-fluid-lg { font-size: clamp(1.2rem, 3.5vmin, 2.5rem); }
        .text-fluid-base { font-size: clamp(1rem, 2.5vmin, 1.5rem); }
        .text-fluid-sm { font-size: clamp(0.875rem, 2vmin, 1.25rem); }
        .icon-fluid-md { font-size: clamp(1.5rem, 4vmin, 3rem); }
        .icon-fluid-lg { font-size: clamp(2rem, 6vmin, 5rem); }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .nav-btn {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        @media (min-width: 1024px) {
            .nav-btn { width: 5rem; height: 5rem; }
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="header" class="absolute top-0 right-0 p-4 md:p-6 z-20 hidden">
        <span id="page-indicator" class="font-mono text-gray-400 font-bold text-fluid-sm bg-gray-100 px-3 py-1 rounded-full">1 / 18</span>
    </div>

    <div id="content-area" class="flex-grow flex flex-col items-center justify-center w-full h-full relative text-center"></div>

    <div id="footer" class="absolute bottom-0 w-full p-6 md:p-8 flex justify-between items-end z-20 pointer-events-none hidden">
        <button id="btn-prev" class="nav-btn bg-gray-100 text-gray-500 hover:bg-gray-200 pointer-events-auto">
            <i class="ph ph-arrow-left icon-fluid-md"></i>
        </button>
        <button id="btn-next" class="nav-btn bg-indigo-600 text-white hover:bg-indigo-700 pointer-events-auto">
            <i class="ph ph-arrow-right icon-fluid-md"></i>
        </button>
    </div>
</div>

<script>
    // --- Configuration ---
    const BASE_44_ORIGIN = "https://coreeno.base44.app"; 
    const CLOVA_API_FUNCTION_URL = BASE_44_ORIGIN + '/api/functions/naverClovaSpeech';

    // Audio Resources
    const AUDIO = {
        WRITER: "https://res.cloudinary.com/de76i94ia/video/upload/v1767260109/%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%80%E1%85%A1_j6x8m9.mp3",
        WHICH: "https://res.cloudinary.com/de76i94ia/video/upload/v1767267944/%E1%84%8B%E1%85%A5%E1%84%82%E1%85%B3_xyjhht.mp3",
        OFFICE_WORKER: "https://res.cloudinary.com/de76i94ia/video/upload/v1767260110/%E1%84%92%E1%85%AC%E1%84%89%E1%85%A1%E1%84%8B%E1%85%AF%E1%86%AB_btaoyu.mp3",
        NAME: "https://res.cloudinary.com/de76i94ia/video/upload/v1766933258/%E1%84%8B%E1%85%B5%E1%84%85%E1%85%B3%E1%86%B7_g9gzd3.mp3",
        
        NOT_YOHAN: "https://res.cloudinary.com/de76i94ia/video/upload/v1767345978/sentence_2_dt0acd.mp3",
        NOT_STUDENT: "https://res.cloudinary.com/de76i94ia/video/upload/v1767347473/sentence_5_l47qvq.mp3",
        NOT_FRENCH: "https://res.cloudinary.com/de76i94ia/video/upload/v1767354007/sentence_6_pisldz.mp3", 
        
        NOT_JENNIE: "https://res.cloudinary.com/de76i94ia/video/upload/v1767345976/sentence_1_ckmoa0.mp3",
        Q_NAME: "https://res.cloudinary.com/de76i94ia/video/upload/v1766933257/sentence_1_nqvqxf.mp3",
        NOT_BELGIAN: "https://res.cloudinary.com/de76i94ia/video/upload/v1767354024/sentence_7_quc9tk.mp3",
        NOT_WRITER: "https://res.cloudinary.com/de76i94ia/video/upload/v1767355914/not_writer_fcdtrh.mp3",

        AM_STUDENT: "https://res.cloudinary.com/de76i94ia/video/upload/v1767087383/sentence_3_ec5vgm.mp3",
        AM_NOT_STUDENT: "https://res.cloudinary.com/de76i94ia/video/upload/v1767347473/sentence_5_l47qvq.mp3", 

        // Conversation Questions
        Q_YOHAN: "https://res.cloudinary.com/de76i94ia/video/upload/v1767355889/are_you_yohan_ai84ld.mp3", 
        AM_YOHAN: "https://res.cloudinary.com/de76i94ia/video/upload/v1766933257/sentence_3_jbqjj5.mp3", 
        
        Q_DOCTOR: "https://res.cloudinary.com/de76i94ia/video/upload/v1767355965/are_you_doctor_capuox.mp3", 
        AM_DOCTOR: "https://res.cloudinary.com/de76i94ia/video/upload/v1767087383/sentence_2_yhhdyr.mp3", 
        NOT_DOCTOR: "https://res.cloudinary.com/de76i94ia/video/upload/v1767345980/sentence_3_vnwspj.mp3", 

        Q_BELGIAN: "https://res.cloudinary.com/de76i94ia/video/upload/v1767356010/are_you_belge_y04iou.mp3", 
        AM_BELGIAN: "https://res.cloudinary.com/de76i94ia/video/upload/v1767267934/sentence_4_nh7qq9.mp3" 
    };

    const pages = [
        {
            type: 'cover',
            title: "Chapitre 4 : Répondre en phrases négatives",
            subtitle: "Leçon 14 - Pratique d'écoute et d'expression orale",
            buttonText: "Commencer"
        },
        // Quiz 1
        {
            type: 'listening_choice',
            instruction: "Choisissez la bonne signification.",
            audio: AUDIO.WRITER,
            options: ["nom", "écrivain", "métier", "étudiant"],
            correct: "écrivain"
        },
        // Quiz 2
        {
            type: 'listening_choice',
            instruction: "Choisissez la bonne signification.",
            audio: AUDIO.WHICH,
            options: ["quel", "comment", "qui", "qu’est-ce que"],
            correct: "quel"
        },
        // Quiz 3
        {
            type: 'listening_choice',
            instruction: "Choisissez la bonne signification.",
            audio: AUDIO.OFFICE_WORKER,
            options: ["médecin", "France", "employée"],
            correct: "employée"
        },
        // Quiz 4
        {
            type: 'listening_choice',
            instruction: "Choisissez la bonne signification.",
            audio: AUDIO.NAME,
            options: ["médecin", "métier", "personne", "prénom"],
            correct: "prénom"
        },
        // Quiz 5 (Shadowing)
        {
            type: 'shadowing',
            instruction: "Répétez après moi.",
            audioPrompt: AUDIO.NOT_YOHAN,
            displayOriginal: "Je ne suis pas Yohan.",
            displayKorean: "저는 요한이 ____.",
            referenceText: "저는 요한이 아니에요"
        },
        // Quiz 6 (Shadowing)
        {
            type: 'shadowing',
            instruction: "Répétez après moi.",
            audioPrompt: AUDIO.NOT_STUDENT,
            displayOriginal: "Je ne suis pas étudiant(e).",
            displayKorean: "저는 학생_ 아니에요.",
            referenceText: "저는 학생이 아니에요"
        },
        // Quiz 7 (Shadowing)
        {
            type: 'shadowing',
            instruction: "Répétez après moi.",
            audioPrompt: AUDIO.NOT_FRENCH,
            displayOriginal: "Je suis français(e).", 
            displayKorean: "저는 프랑스 ___ 아니에요.",
            referenceText: "저는 프랑스 사람이 아니에요"
        },
        // Quiz 8 (Speaking Gap) - Removed audioPrompt, added hintAudio
        {
            type: 'speaking_gap',
            instruction: "Dites-le vous-même.",
            displayOriginal: "Je ne suis pas Jennie.",
            displayKorean: "저는 ___ 아니에요.",
            referenceText: "저는 제니가 아니에요",
            hintAudio: AUDIO.NOT_JENNIE,
            hintThreshold: 1
        },
        // Quiz 9 (Speaking Gap)
        {
            type: 'speaking_gap',
            instruction: "Dites-le vous-même.",
            displayOriginal: "Quel est votre (pré)nom ?",
            displayKorean: "___ ___?",
            referenceText: "이름이 뭐예요",
            hintAudio: AUDIO.Q_NAME,
            hintThreshold: 1
        },
        // Quiz 10 (Speaking Gap)
        {
            type: 'speaking_gap',
            instruction: "Dites-le vous-même.",
            displayOriginal: "Je ne suis pas belge.",
            displayKorean: "저는 벨기에 사람_ ____.",
            referenceText: "저는 벨기에 사람이 아니에요",
            hintAudio: AUDIO.NOT_BELGIAN,
            hintThreshold: 1
        },
        // Quiz 11 (Speaking Gap)
        {
            type: 'speaking_gap',
            instruction: "Dites-le vous-même.",
            displayOriginal: "Je ne suis pas écrivain.",
            displayKorean: "__ ___ ____.",
            referenceText: "저는 작가가 아니에요",
            hintAudio: AUDIO.NOT_WRITER,
            hintThreshold: 1
        },
        // Quiz 12 (Listening Choice - Context)
        {
            type: 'listening_choice',
            instruction: "Est-elle étudiante ?",
            audio: AUDIO.AM_STUDENT, 
            options: ["Oui", "Non", "On ne sait pas"],
            correct: "Oui"
        },
        // Quiz 13 (Listening Choice - Context)
        {
            type: 'listening_choice',
            instruction: "Est-elle coréenne ?",
            audio: AUDIO.NOT_FRENCH, 
            options: ["Oui", "Non", "On ne sait pas"], 
            correct: "On ne sait pas"
        },
        // Quiz 14 (Speaking Choice) - No TextCard, Question Audio Only
        {
            type: 'speaking_choice',
            instruction: "Répondez à la question.",
            questionAudio: AUDIO.Q_YOHAN, // 요한이에요?
            referenceArray: ["저는 요한이에요", "저는 요한이 아니에요"],
            hints: [
                { text: "Je suis Yohan", audio: AUDIO.AM_YOHAN },
                { text: "Je ne suis pas Yohan", audio: AUDIO.NOT_YOHAN }
            ],
            hintThreshold: 1
        },
        // Quiz 15 (Speaking Choice)
        {
            type: 'speaking_choice',
            instruction: "Répondez à la question.",
            questionAudio: AUDIO.Q_DOCTOR, // 의사예요?
            referenceArray: ["저는 의사예요", "저는 의사가 아니에요"],
            hints: [
                { text: "Je suis médecin", audio: AUDIO.AM_DOCTOR },
                { text: "Je ne suis pas médecin", audio: AUDIO.NOT_DOCTOR }
            ],
            hintThreshold: 1
        },
        // Quiz 16 (Speaking Choice)
        {
            type: 'speaking_choice',
            instruction: "Répondez à la question.",
            questionAudio: AUDIO.Q_BELGIAN, // 벨기에 사람이에요?
            referenceArray: ["저는 벨기에 사람이에요", "저는 벨기에 사람이 아니에요"],
            hints: [
                { text: "Je suis belge", audio: AUDIO.AM_BELGIAN },
                { text: "Je ne suis pas belge", audio: AUDIO.NOT_BELGIAN }
            ],
            hintThreshold: 1
        },
        // Outro
        {
            type: 'outro',
            text: "Félicitations ! Vous avez terminé le programme &lt;Parler de soi&gt;. Continuer à parler en coréen dans les leçons supplémentaires !",
            audio: null // No audio
        }
    ];

    // --- Audio & State ---
    let currentPage = 0;
    let audioContextInitialized = false;
    let correctSound, completionSynth, pageTurnSynth;
    let currentAudioObj = null;
    let autoPlayTimer = null;
    const pageStates = {}; 

    async function initAudio() {
        if (audioContextInitialized) return;
        try {
            await Tone.start();
            correctSound = new Tone.Synth().toDestination();
            completionSynth = new Tone.PolySynth(Tone.Synth).toDestination();
            pageTurnSynth = new Tone.MembraneSynth({
                pitchDecay: 0.008, octaves: 1, oscillator: { type: 'sine' },
                envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
            }).toDestination();
            audioContextInitialized = true;
        } catch (e) {
            console.warn("Audio init failed", e);
        }
    }

    function playSound(type) {
        if (!audioContextInitialized) return;
        switch (type) {
            case 'correct': correctSound.triggerAttackRelease('C5', '0.1s'); break;
            case 'turn': pageTurnSynth.triggerAttackRelease("C2", "32n"); break;
            case 'complete': completionSynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "4n"); break;
        }
    }

    function stopCurrentAudio() {
        if (autoPlayTimer) { clearTimeout(autoPlayTimer); autoPlayTimer = null; }
        if (currentAudioObj) {
            currentAudioObj.pause();
            currentAudioObj.currentTime = 0;
            currentAudioObj.onended = null;
            currentAudioObj = null;
        }
    }

    function playAudio(src, onEndCallback) {
        stopCurrentAudio();
        stopRecording(null, true);
        if (!src) {
            console.warn("Audio source missing");
            return;
        }
        currentAudioObj = new Audio(src);
        const playPromise = currentAudioObj.play();
        if (playPromise !== undefined) {
            playPromise.catch(e => { if(!e.message.includes('interrupted')) console.error("Play error:", e); });
        }
        if (onEndCallback) {
            currentAudioObj.onended = onEndCallback;
        }
    }

    // --- UI Logic ---
    const container = document.getElementById('content-area');
    const header = document.getElementById('header');
    const footer = document.getElementById('footer');
    const pageIndicator = document.getElementById('page-indicator');
    const btnNext = document.getElementById('btn-next');
    const btnPrev = document.getElementById('btn-prev');

    function renderPage() {
        stopCurrentAudio();
        stopRecording(null, true); 

        container.innerHTML = '';
        const page = pages[currentPage];
        
        if (!pageStates[currentPage]) pageStates[currentPage] = { attemptsUsed: 0, passed: false };

        pageIndicator.innerText = `${currentPage + 1} / ${pages.length}`;
        
        if (page.type === 'cover') {
            header.classList.add('hidden');
            footer.classList.add('hidden');
        } else {
            header.classList.remove('hidden');
            footer.classList.remove('hidden');
        }

        btnPrev.disabled = currentPage <= 1;
        btnPrev.classList.toggle('opacity-0', currentPage <= 1);
        
        resetNextButton();
        
        switch(page.type) {
            case 'cover': renderCover(page); break;
            case 'text': renderTextPage(page); break;
            case 'card_audio': renderCardAudio(page); break;
            case 'repeat': renderRepeat(page); break;
            case 'speaking_gap': renderSpeakingGap(page); break;
            case 'speaking_choice': renderSpeakingChoice(page); break; 
            case 'outro': renderOutro(page); break;
            case 'listening_choice': renderListeningChoice(page); break;
            case 'shadowing': renderShadowing(page); break;
        }

        checkPageState(page);
    }

    function resetNextButton() {
        btnNext.disabled = false;
        btnNext.classList.remove('bg-gray-400', 'cursor-not-allowed');
        btnNext.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        btnNext.innerHTML = `<i class="ph ph-arrow-right icon-fluid-md"></i>`;
    }

    function disableNextButton() {
        btnNext.disabled = true;
        btnNext.classList.add('bg-gray-400', 'cursor-not-allowed');
        btnNext.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    }

    function checkPageState(page) {
        if (['cover', 'text', 'card_audio', 'outro'].includes(page.type)) return;
        
        const state = pageStates[currentPage];

        if (page.type === 'listening_choice') {
            if (!state.passed) disableNextButton();
            return;
        }

        if (state.passed) {
             // Visual updates if passed
        } else {
            disableNextButton();
            if (state.attemptsUsed >= 3) {
                resetNextButton();
            }
        }
    }

    // --- Renderers ---

    function renderCover(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in text-center">
                <div class="flex flex-col items-center justify-center space-y-[4vh]">
                    <div class="w-[15vh] h-[15vh] bg-indigo-100 rounded-full flex items-center justify-center shadow-inner">
                        <i class="ph ph-headphones text-[8vh] text-indigo-600"></i>
                    </div>
                    <h1 class="text-fluid-xl font-bold text-gray-800 leading-tight">${page.title}</h1>
                    <p class="text-fluid-lg text-gray-600 font-medium">${page.subtitle}</p>
                    <button onclick="nextPage()" class="mt-[5vh] px-[4vw] py-[2vh] bg-indigo-600 text-white rounded-full font-bold text-fluid-base shadow-lg hover:bg-indigo-700 transition transform hover:scale-105">
                        ${page.buttonText}
                    </button>
                </div>
            </div>
        `;
    }

    function renderTextPage(page) {
        if (page.audio) { autoPlayTimer = setTimeout(() => { playAudio(page.audio); }, 1000); }
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <div class="card-box">
                        <p class="text-fluid-base text-gray-700 leading-relaxed text-center">
                            ${page.text}
                        </p>
                    </div>
                </div>
            </div>
        `;
    }

    function renderCardAudio(page) {
        if (page.audio) { autoPlayTimer = setTimeout(() => { playAudio(page.audio); }, 1000); }
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                 <div class="flex flex-col items-center max-w-4xl w-full gap-[2vh]">
                    <div class="card-box py-[4vh] space-y-[2vh]">
                        <h2 class="text-fluid-xl font-bold text-indigo-900 korean-text">${page.mainText}</h2>
                        <div class="flex flex-col items-center">
                            <span class="subtitle-1 text-fluid-sm">${page.sub1}</span>
                            <span class="subtitle-2 text-fluid-base">${page.sub2}</span>
                        </div>
                        <button onclick="playAudio('${page.cardAudio}')" class="mt-[1vh] w-[8vh] h-[8vh] bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 hover:bg-indigo-100 transition shrink-0 shadow-sm">
                            <i class="ph ph-speaker-high icon-fluid-md"></i>
                        </button>
                    </div>
                    ${page.text ? `
                        <div class="bg-indigo-50/50 p-[3vh] rounded-2xl border border-indigo-100 text-center w-full max-w-[800px]">
                            <p class="text-gray-700 text-fluid-base leading-relaxed">${page.text}</p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    function renderRepeat(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    <div class="card-box py-[5vh] space-y-[2vh]">
                        <div class="flex items-center justify-center gap-4">
                            <h2 class="text-fluid-xl font-bold text-indigo-900 korean-text">${page.mainText}</h2>
                            <button onclick="playAudio('${page.cardAudio}')" class="w-[6vh] h-[6vh] bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 hover:bg-indigo-100 transition shadow-sm">
                                <i class="ph ph-speaker-high text-xl"></i>
                            </button>
                        </div>
                        ${page.sub1 ? `<span class="subtitle-1 text-fluid-sm">${page.sub1}</span>` : ''}
                        <span class="subtitle-2 text-fluid-base">${page.sub2}</span>
                    </div>
                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="h-[3vh] text-fluid-sm font-medium text-gray-500">Appuyez pour parler</div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceText, page.attempts);
    }

    function renderListeningChoice(page) {
        const optionHtml = page.options.map(opt => `
            <button class="choice-btn w-full py-4 px-6 bg-gray-50 border-2 border-gray-200 rounded-xl text-lg font-semibold text-gray-700 hover:border-indigo-400 transition" onclick="checkChoice(this, '${opt}', '${page.correct.replace(/'/g, "\\'")}')">
                ${opt}
            </button>
        `).join('');

        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="card-box space-y-6 w-full max-w-xl">
                    <p class="text-sm font-bold text-gray-400 uppercase tracking-wider">${page.instruction}</p>
                    <button onclick="playAudio('${page.audio}')" class="w-[10vh] h-[10vh] bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 hover:bg-indigo-100 transition shadow-sm mx-auto">
                        <i class="ph ph-speaker-high icon-fluid-md"></i>
                    </button>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full">
                        ${optionHtml}
                    </div>
                    <div id="feedback" class="h-8 font-bold"></div>
                </div>
            </div>
        `;
    }

    function checkChoice(btn, selected, correct) {
        const feedback = document.getElementById('feedback');
        if (selected === correct) {
            playSound('correct');
            btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
            feedback.innerHTML = `<span class="text-green-600">Correct !</span>`;
            document.querySelectorAll('.choice-btn').forEach(b => b.disabled = true);
            pageStates[currentPage].passed = true;
            resetNextButton();
        } else {
            playSound('error');
            btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            feedback.innerHTML = `<span class="text-red-500">Essayez encore.</span>`;
        }
    }

    function renderShadowing(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    <div class="card-box py-[5vh] space-y-[2vh]">
                        <button onclick="playAudio('${page.audioPrompt}')" class="mb-4 w-[8vh] h-[8vh] bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 hover:bg-indigo-100 transition shadow-sm mx-auto">
                            <i class="ph ph-speaker-high icon-fluid-md"></i>
                        </button>
                        <h2 class="text-fluid-lg font-bold text-gray-800">${page.displayOriginal}</h2>
                        <p class="text-fluid-xl font-bold text-indigo-900 korean-text">${page.displayKorean}</p>
                    </div>
                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="min-h-[3vh] text-fluid-sm font-medium text-gray-500 flex flex-col items-center justify-center">Appuyez pour parler</div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceText, 3);
    }

    function renderSpeakingGap(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    <div class="card-box py-[5vh] space-y-[2vh]">
                        <h2 class="text-fluid-lg font-bold text-gray-800">${page.displayOriginal}</h2>
                        <p class="text-fluid-xl font-bold text-indigo-900 korean-text">${page.displayKorean}</p>
                    </div>
                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="min-h-[3vh] text-fluid-sm font-medium text-gray-500 flex flex-col items-center justify-center">Appuyez pour parler</div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceText, 3);
    }

    function renderSpeakingChoice(page) {
        // Simplified Layout: Instruction - Audio Button - Mic - Feedback
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center justify-center h-full w-full max-w-4xl gap-[4vh]">
                     <!-- Instruction -->
                     <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>

                     <!-- Audio Button (Question) -->
                     <div class="relative">
                         <div class="absolute -inset-4 bg-indigo-50 rounded-full opacity-50 animate-pulse"></div>
                         <button onclick="playAudio('${page.questionAudio}')" class="relative w-[12vh] h-[12vh] bg-white border-4 border-indigo-100 rounded-full flex items-center justify-center text-indigo-600 shadow-xl hover:scale-105 transition z-10">
                            <i class="ph-fill ph-chats icon-fluid-md"></i>
                        </button>
                     </div>
                     <p class="text-gray-400 text-sm font-medium mt-[-2vh]">Toucher pour écouter</p>
                    
                    <!-- Mic Button -->
                    <div class="flex flex-col items-center gap-[2vh] mt-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-indigo-600 border-4 border-indigo-200 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-indigo-700 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <!-- Feedback Area -->
                        <div id="feedback-msg" class="min-h-[10vh] flex flex-col items-center justify-center text-center w-full max-w-md">
                            <span class="text-gray-400 text-fluid-sm">Appuyez pour répondre</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceArray, 3);
    }

    function renderOutro(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center justify-center space-y-[4vh]">
                    <div class="w-[15vh] h-[15vh] bg-green-100 rounded-full flex items-center justify-center mb-4 text-green-600 animate-bounce shadow-lg">
                        <i class="ph ph-check-fat icon-fluid-lg"></i>
                    </div>
                    <h1 class="text-fluid-xl font-bold text-gray-800">Terminé !</h1>
                    <div class="card-box">
                        <p class="text-fluid-base text-gray-600 text-center leading-relaxed">
                            ${page.text}
                        </p>
                    </div>
                </div>
            </div>
        `;
        if (page.audio) { autoPlayTimer = setTimeout(() => { playAudio(page.audio); }, 1500); }
        initAudio().then(() => {
             playSound('complete');
             window.parent.postMessage({ type: 'lesson_complete' }, '*');
        });
        footer.classList.add('hidden');
    }

    // --- Navigation & Helper ---
    function nextPage() {
        initAudio();
        playSound('turn');
        if (currentPage < pages.length - 1) { currentPage++; renderPage(); }
    }
    function prevPage() {
        playSound('turn');
        if (currentPage > 0) { currentPage--; renderPage(); }
    }

    btnNext.addEventListener('click', nextPage);
    btnPrev.addEventListener('click', prevPage);

    // --- Recording Logic ---
    let mediaRecorder, isRecording = false, recordingTimeout;
    let recordingState = 'idle'; 

    async function setupRecording(btnId, feedbackId, referenceTarget, attemptsMax) {
        const btn = document.getElementById(btnId);
        const feedback = document.getElementById(feedbackId);
        const page = pages[currentPage];
        const state = pageStates[currentPage];

        if (state.passed) { btn.disabled = true; return; }

        btn.onclick = async () => {
            if (attemptsMax && state.attemptsUsed >= attemptsMax && !state.passed) {
                feedback.innerHTML = `<span class="text-orange-500 font-bold">Nombre de tentatives épuisé.</span>`;
                resetNextButton();
                return;
            }

            if (recordingState === 'starting') return; 

            if (recordingState === 'recording') {
                stopRecording(btn);
                return;
            }

            recordingState = 'starting';
            btn.innerHTML = `<i class="ph ph-spinner animate-spin text-2xl"></i>`;
            
            try {
                await initAudio(); 
                stopCurrentAudio(); 
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = async () => {
                        const base64Audio = reader.result.split(',')[1];
                        state.attemptsUsed++;
                        await processAudio(base64Audio, referenceTarget, feedback, btn);
                    };
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                recordingState = 'recording';
                
                btn.classList.add('recording-pulse', 'bg-red-500', 'text-white', 'border-red-500');
                btn.classList.remove('bg-white', 'text-indigo-600', 'border-gray-100');
                if (page.type === 'speaking_choice') {
                    btn.classList.remove('bg-indigo-600', 'border-indigo-200'); // Clean up specific style
                }
                btn.innerHTML = `<i class="ph ph-stop icon-fluid-md"></i>`;
                feedback.innerText = "Écoute en cours...";
                
                if (recordingTimeout) clearTimeout(recordingTimeout);
                recordingTimeout = setTimeout(() => { 
                    if (recordingState === 'recording') stopRecording(btn); 
                }, 10000);

            } catch (err) {
                console.error("Mic Error:", err);
                feedback.innerText = "Erreur micro.";
                recordingState = 'idle';
                btn.innerHTML = `<i class="ph ph-microphone icon-fluid-lg"></i>`;
            }
        };
    }

    function stopRecording(btn, force = false) {
        if (recordingTimeout) clearTimeout(recordingTimeout);
        
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        recordingState = 'idle';
        
        if (btn && !force) {
            btn.classList.remove('recording-pulse', 'bg-red-500', 'text-white', 'border-red-500');
            const page = pages[currentPage];
            if (page.type === 'speaking_choice') {
                btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-200');
            } else {
                btn.classList.add('bg-white', 'text-indigo-600', 'border-gray-100');
            }
            btn.innerHTML = `<i class="ph ph-microphone icon-fluid-lg"></i>`;
        }
    }

    async function processAudio(audioBase64, referenceTarget, feedbackEl, btnEl, forceFail = false) {
        if (!forceFail) feedbackEl.innerText = "Analyse...";
        
        let result = { text: "" };
        let score = 0;
        let passed = false;

        try {
            if (!forceFail && audioBase64) {
                const payload = { audioBase64: audioBase64, languageCode: "Kor" };
                if (typeof referenceTarget === 'string') {
                    payload.referenceText = referenceTarget;
                }
                const res = await fetch(CLOVA_API_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error("API Error");
                result = await res.json();
                score = result.assessment?.pronunciation_score;
            }

            const recognizedText = result.text || "";
            const page = pages[currentPage];
            const displayScore = score !== undefined ? score : '-';
            const normalize = (str) => str ? str.replace(/[\s\.\,\?\!]/g, "") : "";

            // --- Validation Logic ---
            if (!forceFail) {
                if (Array.isArray(referenceTarget)) {
                    const normalizedRec = normalize(recognizedText);
                    const matched = referenceTarget.some(ref => normalize(ref) === normalizedRec);
                    if (matched) passed = true;
                    if (!matched && score >= 85) passed = true; // Fallback score
                } else if (typeof referenceTarget === 'string') { 
                    const scorePass = score >= 80;
                    const textPass = recognizedText && normalize(recognizedText) === normalize(referenceTarget);
                    if (scorePass && textPass) passed = true; 
                } else { 
                    if (recognizedText || score >= 0) passed = true; 
                }
            }

            const state = pageStates[currentPage];
            let msg = "";

            if (passed) {
                state.passed = true;
                playSound('correct'); 
                msg = `<span class="text-green-500 font-bold block mb-1">Excellent ! (${displayScore})</span>`;
                if(btnEl) {
                    btnEl.disabled = true;
                    btnEl.classList.remove('bg-indigo-600', 'bg-white');
                    btnEl.classList.add('bg-green-100', 'border-green-200');
                    btnEl.innerHTML = `<i class="ph ph-check icon-fluid-md text-green-500"></i>`;
                }
                resetNextButton();
            } else {
                if (state.attemptsUsed >= (page.attempts || 3) || forceFail) {
                     msg = `<span class="text-orange-500 font-bold block mb-1">Nombre de tentatives épuisé.</span>`;
                     resetNextButton();
                } else {
                     msg = `<span class="text-red-500 font-bold block mb-1">Réessayez. (${displayScore})</span>`;
                }
            }
            
            if (recognizedText) {
                msg += `<div class="text-indigo-800 font-medium mt-1 text-sm bg-indigo-50 px-3 py-1 rounded-lg">"${recognizedText}"</div>`;
            }

            // Hint Logic 
            const hintThreshold = page.hintThreshold || 99; 
            if ((!passed || forceFail) && state.attemptsUsed >= hintThreshold) {
                 if (page.hintAudio) { // Single hint
                     window.playHint = () => playAudio(page.hintAudio);
                     msg += `<button onclick="playHint()" class="mt-2 flex items-center gap-1 px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs hover:bg-yellow-200 mx-auto transition"><i class="ph ph-speaker-high"></i> Indice</button>`;
                 } else if (page.hints) { // Multiple hints
                     msg += `<div class="flex flex-wrap gap-2 justify-center mt-2">`;
                     page.hints.forEach((h, idx) => {
                         window[`playHint${idx}`] = () => playAudio(h.audio);
                         msg += `<button onclick="playHint${idx}()" class="flex items-center gap-1 px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs hover:bg-yellow-200 transition"><i class="ph ph-speaker-high"></i> ${h.text}</button>`;
                     });
                     msg += `</div>`;
                 }
            }

            feedbackEl.innerHTML = msg;

        } catch (e) {
            console.error(e);
            feedbackEl.innerText = "API Error";
            if(btnEl) btnEl.disabled = false;
        }
    }

    renderPage();
</script>
</body>
</html>
