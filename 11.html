<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parler de soi - Leçon 11</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Hangul.js for Grammar Check -->
    <script src="https://unpkg.com/hangul-js" type="text/javascript"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');

        :root {
            --unit: 1vmin; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .korean-text {
            font-family: 'Noto Sans KR', sans-serif;
        }

        #app-container {
            background-color: white;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        /* Desktop: 16:9 Ratio */
        @media (min-width: 1024px) {
            #app-container {
                aspect-ratio: 16/9;
                width: auto;
                height: 100vh;
                max-width: 177.78vh;
                box-shadow: 0 0 50px rgba(0,0,0,0.5);
            }
            html { font-size: 2.5vh; } 
        }

        /* Mobile */
        @media (max-width: 1023px) {
            #app-container {
                width: 100%;
                height: 100%;
            }
            html { font-size: 16px; }
        }

        .page-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: clamp(2vh, 4vmin, 4vh) clamp(2vw, 4vmin, 4vw);
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .card-box {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            padding: clamp(1.5rem, 4vmin, 3rem);
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex-shrink: 1;
            max-height: 100%;
            overflow-y: auto;
        }

        .text-fluid-xl { font-size: clamp(1.5rem, 5vmin, 4rem); }
        .text-fluid-lg { font-size: clamp(1.2rem, 3.5vmin, 2.5rem); }
        .text-fluid-base { font-size: clamp(1rem, 2.5vmin, 1.5rem); }
        .text-fluid-sm { font-size: clamp(0.875rem, 2vmin, 1.25rem); }
        .icon-fluid-md { font-size: clamp(1.5rem, 4vmin, 3rem); }
        .icon-fluid-lg { font-size: clamp(2rem, 6vmin, 5rem); }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .nav-btn {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        @media (min-width: 1024px) {
            .nav-btn { width: 5rem; height: 5rem; }
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="header" class="absolute top-0 right-0 p-4 md:p-6 z-20 hidden">
        <span id="page-indicator" class="font-mono text-gray-400 font-bold text-fluid-sm bg-gray-100 px-3 py-1 rounded-full">1 / 17</span>
    </div>

    <div id="content-area" class="flex-grow flex flex-col items-center justify-center w-full h-full relative text-center"></div>

    <div id="footer" class="absolute bottom-0 w-full p-6 md:p-8 flex justify-between items-end z-20 pointer-events-none hidden">
        <button id="btn-prev" class="nav-btn bg-gray-100 text-gray-500 hover:bg-gray-200 pointer-events-auto">
            <i class="ph ph-arrow-left icon-fluid-md"></i>
        </button>
        <button id="btn-next" class="nav-btn bg-indigo-600 text-white hover:bg-indigo-700 pointer-events-auto">
            <i class="ph ph-arrow-right icon-fluid-md"></i>
        </button>
    </div>
</div>

<script>
    // --- Configuration ---
    const BASE_44_ORIGIN = "https://coreeno.base44.app"; 
    const CLOVA_API_FUNCTION_URL = BASE_44_ORIGIN + '/api/functions/naverClovaSpeech';
    const PLACEHOLDER_AUDIO = "";

    // Audio Resources
    const AUDIO = {
        NAME: "https://res.cloudinary.com/de76i94ia/video/upload/v1766933258/%E1%84%8B%E1%85%B5%E1%84%85%E1%85%B3%E1%86%B7_g9gzd3.mp3",
        KOREA: PLACEHOLDER_AUDIO, 
        WHICH_COUNTRY: "https://res.cloudinary.com/de76i94ia/video/upload/v1767267946/%E1%84%8B%E1%85%A5%E1%84%82%E1%85%B3_%E1%84%82%E1%85%A1%E1%84%85%E1%85%A1_rgjsfu.mp3",
        PERSON: "https://res.cloudinary.com/de76i94ia/video/upload/v1767267940/%E1%84%89%E1%85%A1%E1%84%85%E1%85%A1%E1%86%B7_iqpmzj.mp3",
        
        Q_NATIONALITY: "https://res.cloudinary.com/de76i94ia/video/upload/v1767267929/sentence_1_mvn2bf.mp3", // 어느 나라 사람이에요?
        AM_FRENCH: "https://res.cloudinary.com/de76i94ia/video/upload/v1767267930/Sentence_2_e1c6t2.mp3", // 저는 프랑스 사람이에요
        AM_BELGIAN: "https://res.cloudinary.com/de76i94ia/video/upload/v1767267934/sentence_4_nh7qq9.mp3", // 저는 벨기에 사람이에요
        
        Q_NAME: "https://res.cloudinary.com/de76i94ia/video/upload/v1766933257/sentence_1_nqvqxf.mp3", // 이름이 뭐예요?
        AM_KOREAN: "https://res.cloudinary.com/de76i94ia/video/upload/v1767267932/Sentence_3_wqx4my.mp3", // 저는 한국 사람이에요
        
        AM_STUDENT: "https://res.cloudinary.com/de76i94ia/video/upload/v1767087383/sentence_3_ec5vgm.mp3" // 저는 학생이에요
    };

    const pages = [
        {
            type: 'cover',
            title: "Chapitre 3 : Demander et dire son origine",
            subtitle: "Leçon 11 - Pratique d'écoute et d'expression orale",
            buttonText: "Commencer"
        },
        // Quiz 1
        {
            type: 'listening_choice',
            instruction: "Choisissez la bonne signification.",
            audio: AUDIO.NAME,
            options: ["prénom", "métier", "être", "pays"],
            correct: "prénom"
        },
        // Quiz 2
        {
            type: 'listening_choice',
            instruction: "Choisissez la bonne signification.",
            audio: AUDIO.KOREA,
            options: ["étudiant", "Corée", "quel"],
            correct: "Corée"
        },
        // Quiz 3
        {
            type: 'listening_choice',
            instruction: "Choisissez la bonne signification.",
            audio: AUDIO.WHICH_COUNTRY,
            options: ["Qu’est-ce que", "quel pays", "qui est", "venir de"],
            correct: "quel pays"
        },
        // Quiz 4
        {
            type: 'listening_choice',
            instruction: "Choisissez la bonne signification.",
            audio: AUDIO.PERSON,
            options: ["médecin", "métier", "personne", "prénom"],
            correct: "personne"
        },
        // Quiz 5 (Shadowing)
        {
            type: 'shadowing',
            instruction: "Répétez après moi.",
            audioPrompt: AUDIO.Q_NATIONALITY,
            displayKorean: "__ 나라 사람이에요?",
            displayTranslation: "Vous venez de quel pays ?",
            referenceText: "어느 나라 사람이에요"
        },
        // Quiz 6 (Shadowing)
        {
            type: 'shadowing',
            instruction: "Répétez après moi.",
            audioPrompt: AUDIO.AM_FRENCH,
            displayKorean: "저는 프랑스 __이에요.",
            displayTranslation: "Je suis français(e).",
            referenceText: "저는 프랑스 사람이에요"
        },
        // Quiz 7 (Shadowing)
        {
            type: 'shadowing',
            instruction: "Répétez après moi.",
            audioPrompt: AUDIO.AM_BELGIAN,
            displayKorean: "저는 ___ __이에요.",
            displayTranslation: "Je suis belge.",
            referenceText: "저는 벨기에 사람이에요"
        },
        // Quiz 8 (Speaking Gap)
        {
            type: 'speaking_gap',
            instruction: "Dites-le vous-même.",
            displayKorean: "어느 나라 __이에요?",
            displayTranslation: "Vous venez de quel pays?",
            referenceText: "어느 나라 사람이에요",
            audioPrompt: AUDIO.Q_NATIONALITY // Hint
        },
        // Quiz 9 (Speaking Gap)
        {
            type: 'speaking_gap',
            instruction: "Dites-le vous-même.",
            displayKorean: "___ ___?",
            displayTranslation: "Quel est votre (pré)nom ?",
            referenceText: "이름이 뭐예요",
            audioPrompt: AUDIO.Q_NAME // Hint
        },
        // Quiz 10 (Speaking Gap)
        {
            type: 'speaking_gap',
            instruction: "Dites-le vous-même.",
            displayKorean: "저는 __ 사람___.",
            displayTranslation: "Je suis coréen(ne).",
            referenceText: "저는 한국 사람이에요",
            audioPrompt: AUDIO.AM_KOREAN // Hint
        },
        // Quiz 11 (Speaking Gap)
        {
            type: 'speaking_gap',
            instruction: "Dites-le vous-même.",
            displayKorean: "__ ___ _____.",
            displayTranslation: "Je suis belge.",
            referenceText: "저는 벨기에 사람이에요",
            audioPrompt: AUDIO.AM_BELGIAN // Hint
        },
        // Quiz 12 (Listening Choice)
        {
            type: 'listening_choice',
            instruction: "Quel est son métier ?",
            audio: AUDIO.AM_STUDENT, 
            options: ["médecin", "étudiant", "professeur"],
            correct: "étudiant"
        },
        // Quiz 13 (Listening Choice)
        {
            type: 'listening_choice',
            instruction: "Quelle est sa nationalité ?",
            audio: AUDIO.AM_FRENCH, 
            options: ["Brésil", "Corée du sud", "France"],
            correct: "France"
        },
        // Quiz 14 (Conv Start)
        {
            type: 'conversation_start',
            instruction: "Posez la question vous-même.",
            displayPrompt: "Vous venez de quel pays?",
            referenceText: "어느 나라 사람이에요",
            replyAudio: AUDIO.AM_KOREAN,
            replyText: "저는 한국 사람이에요.",
            audioPrompt: AUDIO.Q_NATIONALITY // Hint
        },
        // Quiz 15 (Conv Reply) - Modified
        {
            type: 'conversation_reply',
            // instruction removed
            audioPrompt: AUDIO.Q_NATIONALITY, 
            displayHint: "",
            referenceText: null // Open ended
        },
        {
            type: 'outro',
            text: "Félicitation ! Chapitre 4에서 부정 표현을 배워 보세요!",
            // No audio
        }
    ];

    // --- Audio & State ---
    let currentPage = 0;
    let audioContextInitialized = false;
    let correctSound, completionSynth, pageTurnSynth;
    let currentAudioObj = null;
    let autoPlayTimer = null;
    const pageStates = {}; 

    async function initAudio() {
        if (audioContextInitialized) return;
        try {
            await Tone.start();
            correctSound = new Tone.Synth().toDestination();
            completionSynth = new Tone.PolySynth(Tone.Synth).toDestination();
            pageTurnSynth = new Tone.MembraneSynth({
                pitchDecay: 0.008, octaves: 1, oscillator: { type: 'sine' },
                envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
            }).toDestination();
            audioContextInitialized = true;
        } catch (e) {
            console.warn("Audio init failed", e);
        }
    }

    function playSound(type) {
        if (!audioContextInitialized) return;
        switch (type) {
            case 'correct': correctSound.triggerAttackRelease('C5', '0.1s'); break;
            case 'turn': pageTurnSynth.triggerAttackRelease("C2", "32n"); break;
            case 'complete': completionSynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "4n"); break;
        }
    }

    function stopCurrentAudio() {
        if (autoPlayTimer) { clearTimeout(autoPlayTimer); autoPlayTimer = null; }
        if (currentAudioObj) {
            currentAudioObj.pause();
            currentAudioObj.currentTime = 0;
            currentAudioObj.onended = null;
            currentAudioObj = null;
        }
    }

    function playAudio(src, onEndCallback) {
        stopCurrentAudio();
        stopRecording(null, true);
        if (!src) {
            console.warn("Audio source missing");
            return;
        }
        currentAudioObj = new Audio(src);
        const playPromise = currentAudioObj.play();
        if (playPromise !== undefined) {
            playPromise.catch(e => { if(!e.message.includes('interrupted')) console.error("Play error:", e); });
        }
        if (onEndCallback) {
            currentAudioObj.onended = onEndCallback;
        }
    }

    // --- UI Logic ---
    const container = document.getElementById('content-area');
    const header = document.getElementById('header');
    const footer = document.getElementById('footer');
    const pageIndicator = document.getElementById('page-indicator');
    const btnNext = document.getElementById('btn-next');
    const btnPrev = document.getElementById('btn-prev');

    function renderPage() {
        stopCurrentAudio();
        stopRecording(null, true); 

        container.innerHTML = '';
        const page = pages[currentPage];
        
        if (!pageStates[currentPage]) pageStates[currentPage] = { attemptsUsed: 0, passed: false };

        pageIndicator.innerText = `${currentPage + 1} / ${pages.length}`;
        
        if (page.type === 'cover') {
            header.classList.add('hidden');
            footer.classList.add('hidden');
        } else {
            header.classList.remove('hidden');
            footer.classList.remove('hidden');
        }

        btnPrev.disabled = currentPage <= 1;
        btnPrev.classList.toggle('opacity-0', currentPage <= 1);
        
        resetNextButton();
        
        switch(page.type) {
            case 'cover': renderCover(page); break;
            case 'listening_choice': renderListeningChoice(page); break;
            case 'shadowing': renderShadowing(page); break;
            case 'speaking_gap': renderSpeakingGap(page); break;
            case 'conversation_start': renderConversationStart(page); break;
            case 'conversation_reply': renderConversationReply(page); break;
            case 'outro': renderOutro(page); break;
        }

        checkPageState(page);
    }

    function resetNextButton() {
        btnNext.disabled = false;
        btnNext.classList.remove('bg-gray-400', 'cursor-not-allowed');
        btnNext.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        btnNext.innerHTML = `<i class="ph ph-arrow-right icon-fluid-md"></i>`;
    }

    function disableNextButton() {
        btnNext.disabled = true;
        btnNext.classList.add('bg-gray-400', 'cursor-not-allowed');
        btnNext.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    }

    function checkPageState(page) {
        if (['cover', 'outro'].includes(page.type)) return;
        
        const state = pageStates[currentPage];

        if (page.type === 'listening_choice') {
            if (!state.passed) disableNextButton();
            return;
        }

        if (state.passed) {
             const feedback = document.getElementById('feedback-msg');
             const recBtn = document.getElementById('rec-btn');
             if(feedback && !feedback.innerHTML.includes("Excellent")) {
                 feedback.insertAdjacentHTML('afterbegin', `<span class="text-green-500 font-bold block mb-1">Excellent !</span>`);
             }
             if(recBtn) {
                 recBtn.disabled = true;
                 recBtn.innerHTML = `<i class="ph ph-check icon-fluid-md text-green-500"></i>`;
             }
             if (page.type === 'conversation_start') {
                 const replyContainer = document.getElementById('reply-container');
                 if(replyContainer) replyContainer.classList.remove('hidden');
             }
        } else {
            disableNextButton();
            if (state.attemptsUsed >= 3) {
                const feedback = document.getElementById('feedback-msg');
                // Keep the failed state UI from processAudio
                resetNextButton();
            }
        }
    }

    // --- Renderers ---

    function renderCover(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in text-center">
                <div class="flex flex-col items-center justify-center space-y-[4vh]">
                    <div class="w-[15vh] h-[15vh] bg-indigo-100 rounded-full flex items-center justify-center shadow-inner">
                        <i class="ph ph-headphones text-[8vh] text-indigo-600"></i>
                    </div>
                    <h1 class="text-fluid-xl font-bold text-gray-800 leading-tight">${page.title}</h1>
                    <p class="text-fluid-lg text-gray-600 font-medium">${page.subtitle}</p>
                    <button onclick="nextPage()" class="mt-[5vh] px-[4vw] py-[2vh] bg-indigo-600 text-white rounded-full font-bold text-fluid-base shadow-lg hover:bg-indigo-700 transition transform hover:scale-105">
                        ${page.buttonText}
                    </button>
                </div>
            </div>
        `;
    }

    function renderListeningChoice(page) {
        const optionHtml = page.options.map(opt => `
            <button class="choice-btn w-full py-4 px-6 bg-gray-50 border-2 border-gray-200 rounded-xl text-lg font-semibold text-gray-700 hover:border-indigo-400 transition" onclick="checkChoice(this, '${opt}', '${page.correct.replace(/'/g, "\\'")}')">
                ${opt}
            </button>
        `).join('');

        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="card-box space-y-6 w-full max-w-xl">
                    <p class="text-sm font-bold text-gray-400 uppercase tracking-wider">${page.instruction}</p>
                    <button onclick="playAudio('${page.audio}')" class="w-[10vh] h-[10vh] bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 hover:bg-indigo-100 transition shadow-sm mx-auto">
                        <i class="ph ph-speaker-high icon-fluid-md"></i>
                    </button>
                    <div class="flex flex-col gap-3 w-full">
                        ${optionHtml}
                    </div>
                    <div id="feedback" class="h-8 font-bold"></div>
                </div>
            </div>
        `;
    }

    function checkChoice(btn, selected, correct) {
        const feedback = document.getElementById('feedback');
        if (selected === correct) {
            playSound('correct');
            btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
            feedback.innerHTML = `<span class="text-green-600">Correct !</span>`;
            document.querySelectorAll('.choice-btn').forEach(b => b.disabled = true);
            pageStates[currentPage].passed = true;
            resetNextButton();
        } else {
            btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            feedback.innerHTML = `<span class="text-red-500">Essayez encore.</span>`;
        }
    }

    function renderShadowing(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    <div class="card-box py-[5vh] space-y-[2vh]">
                        <button onclick="playAudio('${page.audioPrompt}')" class="mb-4 w-[8vh] h-[8vh] bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 hover:bg-indigo-100 transition shadow-sm mx-auto">
                            <i class="ph ph-speaker-high icon-fluid-md"></i>
                        </button>
                        <h2 class="text-fluid-lg font-bold text-gray-800">${page.displayOriginal}</h2>
                        <p class="text-fluid-xl font-bold text-indigo-900 korean-text">${page.displayKorean}</p>
                    </div>
                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="min-h-[3vh] text-fluid-sm font-medium text-gray-500 flex flex-col items-center justify-center">Appuyez pour parler</div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceText, 3);
    }

    function renderSpeakingGap(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    <div class="card-box py-[5vh] space-y-[2vh]">
                        <h2 class="text-fluid-lg font-bold text-gray-800">${page.displayOriginal}</h2>
                        <p class="text-fluid-xl font-bold text-indigo-900 korean-text">${page.displayKorean}</p>
                    </div>
                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="min-h-[3vh] text-fluid-sm font-medium text-gray-500 flex flex-col items-center justify-center">Appuyez pour parler</div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceText, 3);
    }

    function renderConversationStart(page) {
        const state = pageStates[currentPage];
        const isPassed = state && state.passed;

        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    
                    <div class="card-box py-[5vh] space-y-[2vh]">
                        <p class="text-fluid-xl font-bold text-gray-800 korean-text">${page.displayPrompt}</p>
                        
                        <div id="reply-container" class="${isPassed ? 'block' : 'hidden'} mt-6 pt-6 border-t border-gray-100 w-full animate-fade-in transition-all">
                            <div class="flex flex-col items-center gap-2">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-2">
                                    <i class="ph ph-user-circle text-2xl"></i>
                                </div>
                                <div class="bg-gray-100 rounded-2xl py-3 px-6 text-gray-800 font-bold text-lg korean-text">
                                    ${page.replyText}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="min-h-[3vh] text-fluid-sm font-medium text-gray-500 flex flex-col items-center justify-center w-full">
                            Appuyez pour parler
                        </div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceText, 3);
    }

    function renderConversationReply(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <button onclick="playAudio('${page.audioPrompt}')" class="flex items-center gap-2 px-[3vh] py-[1.5vh] bg-indigo-50 text-indigo-700 rounded-xl text-fluid-sm font-bold hover:bg-indigo-100 transition">
                        <i class="ph ph-speaker-high text-lg"></i> Écouter la question
                    </button>

                    <!-- Instruction Removed Here -->
                    
                    <div class="w-full max-w-[800px] bg-indigo-50 p-[5vh] rounded-[2rem] border-2 border-indigo-200 border-dashed flex flex-col items-center space-y-[1.5vh]">
                        <span class="text-fluid-lg font-bold text-gray-800 text-center">${page.displayHint}</span>
                    </div>
                    
                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="min-h-[3vh] text-fluid-sm font-medium text-gray-500 flex flex-col items-center justify-center w-full">
                            Dites votre nom complet
                        </div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', null, 3);
    }

    function renderOutro(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center justify-center space-y-[4vh]">
                    <div class="w-[15vh] h-[15vh] bg-green-100 rounded-full flex items-center justify-center mb-4 text-green-600 animate-bounce shadow-lg">
                        <i class="ph ph-check-fat icon-fluid-lg"></i>
                    </div>
                    <h1 class="text-fluid-xl font-bold text-gray-800">Terminé !</h1>
                    <div class="card-box">
                        <p class="text-fluid-base text-gray-600 text-center leading-relaxed">
                            ${page.text}
                        </p>
                    </div>
                </div>
            </div>
        `;
        initAudio().then(() => {
             playSound('complete');
             window.parent.postMessage({ type: 'lesson_complete' }, '*');
        });
        footer.classList.add('hidden');
    }

    // --- Navigation & Helper ---
    function nextPage() {
        initAudio();
        playSound('turn');
        if (currentPage < pages.length - 1) { currentPage++; renderPage(); }
    }
    function prevPage() {
        playSound('turn');
        if (currentPage > 0) { currentPage--; renderPage(); }
    }

    btnNext.addEventListener('click', nextPage);
    btnPrev.addEventListener('click', prevPage);

    // --- Recording Logic ---
    let mediaRecorder, isRecording = false, recordingTimeout;
    let recordingState = 'idle'; 

    async function setupRecording(btnId, feedbackId, referenceText, attemptsMax) {
        const btn = document.getElementById(btnId);
        const feedback = document.getElementById(feedbackId);
        const page = pages[currentPage];
        const state = pageStates[currentPage];

        if (state.passed) { btn.disabled = true; return; }

        btn.onclick = async () => {
            if (attemptsMax && state.attemptsUsed >= attemptsMax && !state.passed) {
                feedback.innerText = "Nombre de tentatives épuisé.";
                resetNextButton();
                // Special logic for Quiz 14 (Conv Start) to show reply even if failed
                if (page.type === 'conversation_start') {
                    const replyContainer = document.getElementById('reply-container');
                    if(replyContainer) replyContainer.classList.remove('hidden');
                }
                return;
            }

            if (recordingState === 'starting') return; 

            if (recordingState === 'recording') {
                stopRecording(btn);
                return;
            }

            recordingState = 'starting';
            btn.innerHTML = `<i class="ph ph-spinner animate-spin text-2xl"></i>`;
            
            try {
                await initAudio(); 
                stopCurrentAudio(); 
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = async () => {
                        const base64Audio = reader.result.split(',')[1];
                        state.attemptsUsed++;
                        await processAudio(base64Audio, referenceText, feedback, btn);
                    };
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                recordingState = 'recording';
                
                btn.classList.add('recording-pulse', 'bg-red-500', 'text-white', 'border-red-500');
                btn.classList.remove('bg-white', 'text-indigo-600', 'border-gray-100');
                btn.innerHTML = `<i class="ph ph-stop icon-fluid-md"></i>`;
                feedback.innerText = "Écoute en cours...";
                
                if (recordingTimeout) clearTimeout(recordingTimeout);
                recordingTimeout = setTimeout(() => { 
                    if (recordingState === 'recording') stopRecording(btn); 
                }, 10000);

            } catch (err) {
                console.error("Mic Error:", err);
                feedback.innerText = "Erreur micro.";
                recordingState = 'idle';
                btn.innerHTML = `<i class="ph ph-microphone icon-fluid-lg"></i>`;
            }
        };
    }

    function stopRecording(btn, force = false) {
        if (recordingTimeout) clearTimeout(recordingTimeout);
        
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        recordingState = 'idle';
        
        if (btn && !force) {
            btn.classList.remove('recording-pulse', 'bg-red-500', 'text-white', 'border-red-500');
            btn.classList.add('bg-white', 'text-indigo-600', 'border-gray-100');
            btn.innerHTML = `<i class="ph ph-microphone icon-fluid-lg"></i>`;
        }
    }

    // --- Grammar Check for Quiz 13 (Nationality) ---
    function checkKoreanNationalityGrammar(text) {
        if (!text) return false;
        
        // Target: 저는 ... 사람이에요 (Must end with 사람이에요)
        if (!text.endsWith('사람이에요')) return false;
        if (!text.startsWith("저는")) return false;
        
        // Strip spaces
        const core = text.replace(/\s+/g, '');
        // "저는" + country + "사람이에요"
        // Length of "저는사람이에요" is 7. So text must be longer than 7.
        if (core.length <= 7) return false;

        return true;
    }

    async function processAudio(audioBase64, referenceText, feedbackEl, btnEl, forceFail = false) {
        if (!forceFail) feedbackEl.innerText = "Analyse...";
        
        let result = { text: "" };
        let score = 0;
        let passed = false;

        try {
            if (!forceFail && audioBase64) {
                const payload = { audioBase64: audioBase64, languageCode: "Kor" };
                if (referenceText) payload.referenceText = referenceText;

                const res = await fetch(CLOVA_API_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("API Error");
                result = await res.json();
                score = result.assessment?.pronunciation_score;
            }

            const recognizedText = result.text || "";
            const page = pages[currentPage];
            const displayScore = score !== undefined ? score : '-';
            const normalize = (str) => str ? str.replace(/[\s\.\,\?\!]/g, "") : "";

            // --- Validation Logic ---
            if (!forceFail) {
                if (page.type === 'conversation_reply') {
                    // Quiz 13: Special Grammar Check (Nationality)
                    passed = checkKoreanNationalityGrammar(recognizedText);
                } else if (referenceText) { 
                    const normalize = (str) => str ? str.replace(/[\s\.\,\?\!]/g, "") : "";
                    const scorePass = score >= 80;
                    const textPass = recognizedText && normalize(recognizedText) === normalize(referenceText);
                    if (scorePass && textPass) passed = true; 
                } else { 
                    // Fallback for other open ended if any
                    if (recognizedText || score >= 0) passed = true; 
                }
            }

            const state = pageStates[currentPage];
            let msg = "";

            if (passed) {
                state.passed = true;
                playSound('correct'); 
                const scoreText = page.type.includes('conversation_reply') ? '' : ` (${displayScore})`;
                msg = `<span class="text-green-500 font-bold block mb-1">Excellent !${scoreText}</span>`;
                if(btnEl) {
                    btnEl.disabled = true;
                    btnEl.innerHTML = `<i class="ph ph-check icon-fluid-md text-green-500"></i>`;
                }
                resetNextButton();

                // Quiz 12 Success: Auto Play Reply
                if (page.type === 'conversation_start') {
                     if(page.replyAudio) setTimeout(() => { playAudio(page.replyAudio); }, 500);
                }

            } else {
                if (state.attemptsUsed >= (page.attempts || 3) || forceFail) {
                     msg = `<span class="text-orange-500 block mb-1">Nombre de tentatives épuisé.</span>`;
                     resetNextButton();
                } else {
                     msg = `<span class="text-orange-500 block mb-1">Réessayez. (${displayScore})</span>`;
                }
            }
            
            if (recognizedText) {
                msg += `<div class="text-indigo-600 font-medium mt-1 text-sm">"${recognizedText}"</div>`;
            }

            // Hint Logic (Not for Repeat pages)
            // Shadowing (Quiz 4, 5, 6) has audioPrompt but should NOT show button because card has it
            const isExcludedFromHint = page.type === 'repeat' || page.type === 'shadowing' || page.type === 'conversation_reply';
            
            if ((!passed || forceFail) && page.audioPrompt && !isExcludedFromHint) {
                 window.playHint = () => playAudio(page.audioPrompt);
                 msg += `<button onclick="playHint()" class="mt-2 flex items-center gap-1 px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs hover:bg-yellow-200 mx-auto transition"><i class="ph ph-speaker-high"></i> Réécouter</button>`;
            }

            // Quiz 12 (Conv Start) Special: Show Reply Card BELOW transcription/hint
            if (page.type === 'conversation_start' && (passed || state.attemptsUsed >= 3)) {
                 const replyContainer = document.getElementById('reply-container');
                 if(replyContainer) replyContainer.classList.remove('hidden');
            }

            feedbackEl.innerHTML = msg;

        } catch (e) {
            console.error(e);
            feedbackEl.innerText = "API Error";
            if(btnEl) btnEl.disabled = false;
        }
    }

    renderPage();
</script>
</body>
</html>
