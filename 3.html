<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parler de soi - Leçon 3</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Hangul.js for Grammar Check -->
    <script src="https://unpkg.com/hangul-js" type="text/javascript"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');

        :root {
            --unit: 1vmin; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .korean-text {
            font-family: 'Noto Sans KR', sans-serif;
        }

        #app-container {
            background-color: white;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        /* Desktop: 16:9 Ratio */
        @media (min-width: 1024px) {
            #app-container {
                aspect-ratio: 16/9;
                width: auto;
                height: 100vh;
                max-width: 177.78vh;
                box-shadow: 0 0 50px rgba(0,0,0,0.5);
            }
            html { font-size: 2.5vh; } 
        }

        /* Mobile */
        @media (max-width: 1023px) {
            #app-container {
                width: 100%;
                height: 100%;
            }
            html { font-size: 16px; }
        }

        .page-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: clamp(2vh, 4vmin, 4vh) clamp(2vw, 4vmin, 4vw);
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .card-box {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            padding: clamp(1.5rem, 4vmin, 3rem);
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex-shrink: 1;
            max-height: 100%;
            overflow-y: auto;
        }

        .text-fluid-xl { font-size: clamp(1.5rem, 5vmin, 4rem); }
        .text-fluid-lg { font-size: clamp(1.2rem, 3.5vmin, 2.5rem); }
        .text-fluid-base { font-size: clamp(1rem, 2.5vmin, 1.5rem); }
        .text-fluid-sm { font-size: clamp(0.875rem, 2vmin, 1.25rem); }
        .icon-fluid-md { font-size: clamp(1.5rem, 4vmin, 3rem); }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .nav-btn {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        @media (min-width: 1024px) {
            .nav-btn { width: 5rem; height: 5rem; }
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="header" class="absolute top-0 right-0 p-4 md:p-6 z-20 hidden">
        <span id="page-indicator" class="font-mono text-gray-400 font-bold text-fluid-sm bg-gray-100 px-3 py-1 rounded-full">1 / 15</span>
    </div>

    <div id="content-area" class="flex-grow flex flex-col items-center justify-center w-full h-full relative"></div>

    <div id="footer" class="absolute bottom-0 w-full p-6 md:p-8 flex justify-between items-end z-20 pointer-events-none hidden">
        <button id="btn-prev" class="nav-btn bg-gray-100 text-gray-500 hover:bg-gray-200 pointer-events-auto">
            <i class="ph ph-arrow-left icon-fluid-md"></i>
        </button>
        <button id="btn-next" class="nav-btn bg-indigo-600 text-white hover:bg-indigo-700 pointer-events-auto">
            <i class="ph ph-arrow-right icon-fluid-md"></i>
        </button>
    </div>
</div>

<script>
    // --- Configuration ---
    const BASE_44_ORIGIN = "https://coreeno.base44.app"; 
    const CLOVA_API_FUNCTION_URL = BASE_44_ORIGIN + '/api/functions/naverClovaSpeech';
    const PLACEHOLDER_AUDIO = ""; // Used for missing files

    // Audio Links
    const AUDIO_NAME = "https://res.cloudinary.com/de76i94ia/video/upload/v1766933258/%E1%84%8B%E1%85%B5%E1%84%85%E1%85%B3%E1%86%B7_g9gzd3.mp3";
    const AUDIO_JE_TOPIC = "https://res.cloudinary.com/de76i94ia/video/upload/v1766933257/%E1%84%8C%E1%85%A5%E1%84%82%E1%85%B3%E1%86%AB_cisbyn.mp3";
    const AUDIO_WHAT = "https://res.cloudinary.com/de76i94ia/video/upload/v1766933257/%E1%84%86%E1%85%AF%E1%84%8B%E1%85%A8%E1%84%8B%E1%85%AD_mowaek.mp3";
    const AUDIO_SENTENCE_NAME = "https://res.cloudinary.com/de76i94ia/video/upload/v1766933257/sentence_1_nqvqxf.mp3"; // 이름이 뭐예요?
    const AUDIO_SENTENCE_JENNIE = "https://res.cloudinary.com/de76i94ia/video/upload/v1766933257/sentene_2_r4d0es.mp3"; // 저는 제니예요
    const AUDIO_SENTENCE_YOHAN = "https://res.cloudinary.com/de76i94ia/video/upload/v1766933257/sentence_3_jbqjj5.mp3"; // 저는 요한이에요
    const AUDIO_SENTENCE_JULIE = "https://res.cloudinary.com/de76i94ia/video/upload/v1767084669/%E1%84%8C%E1%85%AE%E1%86%AF%E1%84%85%E1%85%B5_dh1f0t.mp3"; // 저는 줄리예요
    const AUDIO_SENTENCE_SUBIN = "https://res.cloudinary.com/de76i94ia/video/upload/v1767084670/%E1%84%89%E1%85%AE%E1%84%87%E1%85%B5%E1%86%AB_h5e55p.mp3"; // 저는 수빈이에요

    const pages = [
        {
            type: 'cover',
            title: "Chapitre 1 : Demander et dire son nom",
            subtitle: "Leçon 3 - Pratique d'écoute et d'expression orale",
            buttonText: "Commencer"
        },
        // Quiz 1
        {
            type: 'listening_choice',
            instruction: "Choisissez la bonne signification.",
            audio: AUDIO_NAME,
            options: ["Prénom", "Nom de famille", "Être"],
            correct: "Prénom"
        },
        // Quiz 2
        {
            type: 'listening_choice',
            instruction: "Choisissez la bonne signification.",
            audio: AUDIO_JE_TOPIC,
            options: ["Je suis", "Vous", "Je"],
            correct: "Je"
        },
        // Quiz 3
        {
            type: 'listening_choice',
            instruction: "Choisissez la bonne signification.",
            audio: AUDIO_WHAT,
            options: ["Comment tu t’appelles?", "Qu’est-ce que (quel est)", "Qui"],
            correct: "Qu’est-ce que (quel est)"
        },
        // Quiz 4 (Shadowing)
        {
            type: 'shadowing',
            instruction: "Répétez après moi.",
            audioPrompt: AUDIO_SENTENCE_NAME,
            displayOriginal: "Quel est votre (pré)nom?",
            displayKorean: "___이 뭐예요?",
            referenceText: "이름이 뭐예요"
        },
        // Quiz 5 (Shadowing)
        {
            type: 'shadowing',
            instruction: "Répétez après moi.",
            audioPrompt: AUDIO_SENTENCE_JENNIE,
            displayOriginal: "Je suis Jennie.",
            displayKorean: "___ 제니예요.",
            referenceText: "저는 제니예요"
        },
        // Quiz 6 (Shadowing)
        {
            type: 'shadowing',
            instruction: "Répétez après moi.",
            audioPrompt: AUDIO_SENTENCE_YOHAN,
            displayOriginal: "Je suis Yohan.",
            displayKorean: "__ 요한 ___ .",
            referenceText: "저는 요한이에요"
        },
        // Quiz 7 (Speaking Gap)
        {
            type: 'speaking_gap',
            instruction: "Dites-le vous-même.",
            displayOriginal: "Quel est votre (pré)nom?",
            displayKorean: "___이 뭐예요?",
            referenceText: "이름이 뭐예요",
            audioPrompt: AUDIO_SENTENCE_NAME // For hint
        },
        // Quiz 8 (Speaking Gap)
        {
            type: 'speaking_gap',
            instruction: "Dites-le vous-même.",
            displayOriginal: "Je suis Jennie.",
            displayKorean: "___ 제니 __.",
            referenceText: "저는 제니예요",
            audioPrompt: AUDIO_SENTENCE_JENNIE // For hint
        },
        // Quiz 9 (Speaking Gap)
        {
            type: 'speaking_gap',
            instruction: "Dites-le vous-même.",
            displayOriginal: "Je suis Yohan.",
            displayKorean: "___ 요한 ____ .",
            referenceText: "저는 요한이에요",
            audioPrompt: AUDIO_SENTENCE_YOHAN // For hint
        },
        // Quiz 10 (Listening - Julie)
        {
            type: 'listening_choice',
            instruction: "Comment s'appelle cette personne ?",
            audio: AUDIO_SENTENCE_JULIE, 
            options: ["Jennie", "Julie", "Julien"],
            correct: "Julie"
        },
        // Quiz 11 (Listening - Subin)
        {
            type: 'listening_choice',
            instruction: "Comment s'appelle cette personne ?",
            audio: AUDIO_SENTENCE_SUBIN, 
            options: ["Subin", "Seb", "Somin"],
            correct: "Subin"
        },
        // Quiz 12 (Direct Question + Auto Reply)
        {
            type: 'conversation_start',
            instruction: "Posez la question vous-même.",
            displayPrompt: "[ 이름이 뭐예요? ]",
            referenceText: "이름이 뭐예요",
            replyAudio: AUDIO_SENTENCE_JENNIE,
            replyText: "저는 제니예요.",
            audioPrompt: AUDIO_SENTENCE_NAME // For hint
        },
        // Quiz 13 (Conversation Reply + Transcription)
        {
            type: 'conversation_reply',
            instruction: "Répondez à la question.",
            audioPrompt: AUDIO_SENTENCE_NAME, // Question: 이름이 뭐예요?
            displayHint: "Je suis [Votre Nom].",
            referenceText: null // handled by grammar check
        },
        {
            type: 'outro',
            text: "Félicitations ! Apprenez à demander et dire votre profession dans la Leçon 4 !",
            // Audio removed
        }
    ];

    // --- Audio & State ---
    let currentPage = 0;
    let audioContextInitialized = false;
    let correctSound, errorSound, completionSynth, pageTurnSynth;
    let currentAudioObj = null;
    let autoPlayTimer = null;
    const pageStates = {}; 

    async function initAudio() {
        if (audioContextInitialized) return;
        try {
            await Tone.start();
            correctSound = new Tone.Synth().toDestination();
            errorSound = new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 }
            }).toDestination();
            completionSynth = new Tone.PolySynth(Tone.Synth).toDestination();
            pageTurnSynth = new Tone.MembraneSynth().toDestination();
            audioContextInitialized = true;
        } catch (e) {
            console.warn("Audio init failed", e);
        }
    }

    // Unified Sound Function
    function playSound(type) {
        if (!audioContextInitialized) return;
        switch (type) {
            case 'correct': correctSound.triggerAttackRelease('C5', '0.1s'); break;
            case 'error': errorSound.triggerAttackRelease('A2', '0.1s'); break;
            case 'turn': pageTurnSynth.triggerAttackRelease("C2", "32n"); break;
            case 'complete': completionSynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "4n"); break;
        }
    }

    function stopCurrentAudio() {
        if (autoPlayTimer) { clearTimeout(autoPlayTimer); autoPlayTimer = null; }
        if (currentAudioObj) {
            currentAudioObj.pause();
            currentAudioObj.currentTime = 0;
            currentAudioObj.onended = null;
            currentAudioObj = null;
        }
    }

    function playAudio(src, onEndCallback) {
        // Optimization: Stop recording if audio plays to prevent overlap
        stopRecording(null, true);
        
        stopCurrentAudio();
        if (!src) {
            console.warn("Audio source missing");
            return;
        }
        currentAudioObj = new Audio(src);
        const playPromise = currentAudioObj.play();
        if (playPromise !== undefined) {
            playPromise.catch(e => { if(!e.message.includes('interrupted')) console.error("Play error:", e); });
        }
        if (onEndCallback) {
            currentAudioObj.onended = onEndCallback;
        }
    }

    // --- UI Logic ---
    const container = document.getElementById('content-area');
    const header = document.getElementById('header');
    const footer = document.getElementById('footer');
    const pageIndicator = document.getElementById('page-indicator');
    const btnNext = document.getElementById('btn-next');
    const btnPrev = document.getElementById('btn-prev');

    function renderPage() {
        stopCurrentAudio();
        stopRecording(null, true); 

        container.innerHTML = '';
        const page = pages[currentPage];
        
        if (!pageStates[currentPage]) pageStates[currentPage] = { attemptsUsed: 0, passed: false };

        pageIndicator.innerText = `${currentPage + 1} / ${pages.length}`;
        
        if (page.type === 'cover') {
            header.classList.add('hidden');
            footer.classList.add('hidden');
        } else {
            header.classList.remove('hidden');
            footer.classList.remove('hidden');
        }

        btnPrev.disabled = currentPage <= 1;
        btnPrev.classList.toggle('opacity-0', currentPage <= 1);
        
        resetNextButton();
        
        switch(page.type) {
            case 'cover': renderCover(page); break;
            case 'listening_choice': renderListeningChoice(page); break;
            case 'shadowing': renderShadowing(page); break;
            case 'speaking_gap': renderSpeakingGap(page); break;
            case 'conversation_start': renderConversationStart(page); break;
            case 'conversation_reply': renderConversationReply(page); break;
            case 'outro': renderOutro(page); break;
        }

        checkPageState(page);
    }

    function resetNextButton() {
        btnNext.disabled = false;
        btnNext.classList.remove('bg-gray-400', 'cursor-not-allowed');
        btnNext.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    }

    function disableNextButton() {
        btnNext.disabled = true;
        btnNext.classList.add('bg-gray-400', 'cursor-not-allowed');
        btnNext.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    }

    function checkPageState(page) {
        if (['cover', 'outro'].includes(page.type)) return;
        
        const state = pageStates[currentPage];

        if (page.type === 'listening_choice') {
            if (!state.passed) disableNextButton();
            return;
        }

        if (state.passed) {
             const feedback = document.getElementById('feedback-msg');
             const recBtn = document.getElementById('rec-btn');
             if(feedback && !feedback.innerHTML.includes("Excellent")) {
                 feedback.insertAdjacentHTML('afterbegin', `<span class="text-green-500 font-bold block mb-1">Excellent !</span>`);
             }
             if(recBtn) {
                 recBtn.disabled = true;
                 recBtn.innerHTML = `<i class="ph ph-check icon-fluid-md text-green-500"></i>`;
             }
             if (page.type === 'conversation_start') {
                 const replyContainer = document.getElementById('reply-container');
                 if(replyContainer) replyContainer.classList.remove('hidden');
             }
        } else {
            disableNextButton();
            if (state.attemptsUsed >= 3) {
                // If failed 3 times, allow pass
                resetNextButton();
            }
        }
    }

    // --- Renderers ---

    function renderCover(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in text-center">
                <div class="flex flex-col items-center justify-center space-y-[4vh]">
                    <div class="w-[15vh] h-[15vh] bg-indigo-100 rounded-full flex items-center justify-center shadow-inner">
                        <i class="ph ph-headphones text-[8vh] text-indigo-600"></i>
                    </div>
                    <h1 class="text-fluid-xl font-bold text-gray-800 leading-tight">${page.title}</h1>
                    <p class="text-fluid-lg text-gray-600 font-medium">${page.subtitle}</p>
                    <button onclick="nextPage()" class="mt-[5vh] px-[4vw] py-[2vh] bg-indigo-600 text-white rounded-full font-bold text-fluid-base shadow-lg hover:bg-indigo-700 transition transform hover:scale-105">
                        ${page.buttonText}
                    </button>
                </div>
            </div>
        `;
    }

    function renderListeningChoice(page) {
        const optionHtml = page.options.map(opt => `
            <button class="choice-btn w-full py-4 px-6 bg-gray-50 border-2 border-gray-200 rounded-xl text-lg font-semibold text-gray-700 hover:border-indigo-400 transition" onclick="checkChoice(this, '${opt}', '${page.correct.replace(/'/g, "\\'")}')">
                ${opt}
            </button>
        `).join('');

        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="card-box space-y-6 w-full max-w-xl">
                    <p class="text-sm font-bold text-gray-400 uppercase tracking-wider">${page.instruction}</p>
                    <button onclick="playAudio('${page.audio}')" class="w-[10vh] h-[10vh] bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 hover:bg-indigo-100 transition shadow-sm mx-auto">
                        <i class="ph ph-speaker-high icon-fluid-md"></i>
                    </button>
                    <div class="flex flex-col gap-3 w-full">
                        ${optionHtml}
                    </div>
                    <div id="feedback" class="h-8 font-bold"></div>
                </div>
            </div>
        `;
    }

    function checkChoice(btn, selected, correct) {
        const feedback = document.getElementById('feedback');
        if (selected === correct) {
            playSound('correct');
            btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
            feedback.innerHTML = `<span class="text-green-600">Correct !</span>`;
            document.querySelectorAll('.choice-btn').forEach(b => b.disabled = true);
            
            pageStates[currentPage].passed = true;
            resetNextButton();
        } else {
            playSound('error');
            btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            feedback.innerHTML = `<span class="text-red-500">Essayez encore.</span>`;
        }
    }

    function renderShadowing(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    <div class="card-box py-[5vh] space-y-[2vh]">
                        <button onclick="playAudio('${page.audioPrompt}')" class="mb-4 w-[8vh] h-[8vh] bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 hover:bg-indigo-100 transition shadow-sm mx-auto">
                            <i class="ph ph-speaker-high icon-fluid-md"></i>
                        </button>
                        <h2 class="text-fluid-lg font-bold text-gray-800">${page.displayOriginal}</h2>
                        <p class="text-fluid-xl font-bold text-indigo-900 korean-text">${page.displayKorean}</p>
                    </div>
                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="min-h-[3vh] text-fluid-sm font-medium text-gray-500 flex flex-col items-center justify-center">Appuyez pour parler</div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceText, 3);
    }

    function renderSpeakingGap(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    <div class="card-box py-[5vh] space-y-[2vh]">
                        <h2 class="text-fluid-lg font-bold text-gray-800">${page.displayOriginal}</h2>
                        <p class="text-fluid-xl font-bold text-indigo-900 korean-text">${page.displayKorean}</p>
                    </div>
                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="min-h-[3vh] text-fluid-sm font-medium text-gray-500 flex flex-col items-center justify-center">Appuyez pour parler</div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceText, 3);
    }

    function renderConversationStart(page) {
        const state = pageStates[currentPage];
        const isPassed = state && state.passed;

        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    
                    <div class="card-box py-[5vh] space-y-[2vh]">
                        <p class="text-fluid-xl font-bold text-gray-800 korean-text">${page.displayPrompt}</p>
                        
                        <div id="reply-container" class="${isPassed ? 'block' : 'hidden'} mt-6 pt-6 border-t border-gray-100 w-full animate-fade-in">
                            <div class="flex flex-col items-center gap-2">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-2">
                                    <i class="ph ph-user-circle text-2xl"></i>
                                </div>
                                <div class="bg-gray-100 rounded-2xl py-3 px-6 text-gray-800 font-bold text-lg korean-text">
                                    ${page.replyText}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="min-h-[3vh] text-fluid-sm font-medium text-gray-500 flex flex-col items-center justify-center w-full">
                            Appuyez pour parler
                        </div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', page.referenceText, 3);
    }

    function renderConversationReply(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center max-w-4xl w-full gap-[3vh]">
                    <button onclick="playAudio('${page.audioPrompt}')" class="flex items-center gap-2 px-[3vh] py-[1.5vh] bg-indigo-50 text-indigo-700 rounded-xl text-fluid-sm font-bold hover:bg-indigo-100 transition">
                        <i class="ph ph-speaker-high text-lg"></i> Écouter la question
                    </button>

                    <p class="text-gray-500 font-bold uppercase tracking-widest text-fluid-sm">${page.instruction}</p>
                    
                    <div class="w-full max-w-[800px] bg-indigo-50 p-[5vh] rounded-[2rem] border-2 border-indigo-200 border-dashed flex flex-col items-center space-y-[1.5vh]">
                        <span class="text-fluid-lg font-bold text-gray-800 text-center">${page.displayHint}</span>
                    </div>
                    
                    <div class="flex flex-col items-center gap-[2vh]">
                        <button id="rec-btn" class="w-[12vh] h-[12vh] bg-white border-4 border-gray-100 rounded-full flex items-center justify-center text-indigo-600 shadow-lg hover:border-indigo-200 transition-all hover:scale-105">
                            <i class="ph ph-microphone icon-fluid-lg"></i>
                        </button>
                        <div id="feedback-msg" class="min-h-[3vh] text-fluid-sm font-medium text-gray-500 flex flex-col items-center justify-center w-full">
                            Dites votre nom complet
                        </div>
                    </div>
                </div>
            </div>
        `;
        setupRecording('rec-btn', 'feedback-msg', null, 3);
    }

    function renderOutro(page) {
        container.innerHTML = `
            <div class="page-wrapper fade-in">
                <div class="flex flex-col items-center justify-center space-y-[4vh]">
                    <div class="w-[15vh] h-[15vh] bg-green-100 rounded-full flex items-center justify-center mb-4 text-green-600 animate-bounce shadow-lg">
                        <i class="ph ph-check-fat icon-fluid-lg"></i>
                    </div>
                    <h1 class="text-fluid-xl font-bold text-gray-800">Terminé !</h1>
                    <div class="card-box">
                        <p class="text-fluid-base text-gray-600 text-center leading-relaxed">
                            ${page.text}
                        </p>
                    </div>
                </div>
            </div>
        `;
        initAudio().then(() => {
             playSound('complete');
             window.parent.postMessage({ type: 'lesson_complete' }, '*');
        });
        footer.classList.add('hidden');
    }

    // --- Navigation & Helper ---
    function nextPage() {
        initAudio();
        playSound('turn');
        if (currentPage < pages.length - 1) { currentPage++; renderPage(); }
    }
    function prevPage() {
        playSound('turn');
        if (currentPage > 0) { currentPage--; renderPage(); }
    }

    btnNext.addEventListener('click', nextPage);
    btnPrev.addEventListener('click', prevPage);

    // --- Recording Logic ---
    let mediaRecorder, isRecording = false, recordingTimeout;

    async function setupRecording(btnId, feedbackId, referenceText, attemptsMax) {
        const btn = document.getElementById(btnId);
        const feedback = document.getElementById(feedbackId);
        const page = pages[currentPage];
        const state = pageStates[currentPage];

        if (state.passed) { btn.disabled = true; return; }

        btn.onclick = async () => {
            if (attemptsMax && state.attemptsUsed >= attemptsMax && !state.passed) {
                feedback.innerText = "Nombre de tentatives épuisé.";
                resetNextButton();
                // Special logic for Quiz 12 (Conv Start) to show reply even if failed
                if (page.type === 'conversation_start') {
                    await processAudio(null, referenceText, feedback, btn, true); 
                }
                return;
            }

            if (!isRecording) {
                try {
                    await initAudio(); 
                    
                    // Prevent Playing Audio & Recording at same time
                    stopCurrentAudio();
                    
                    // Add loading state
                    btn.disabled = true;
                    btn.innerHTML = `<i class="ph ph-spinner animate-spin text-2xl"></i>`;

                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    const audioChunks = [];
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    
                    mediaRecorder.onstart = () => {
                         btn.disabled = false;
                         isRecording = true;
                         btn.classList.add('recording-pulse', 'bg-red-500', 'text-white', 'border-red-500');
                         btn.classList.remove('bg-white', 'text-indigo-600', 'border-gray-100');
                         btn.innerHTML = `<i class="ph ph-stop icon-fluid-md"></i>`;
                         feedback.innerText = "Écoute en cours...";
                         // 10s auto stop logic
                         if (recordingTimeout) clearTimeout(recordingTimeout);
                         recordingTimeout = setTimeout(() => { 
                            if (isRecording) stopRecording(btn); 
                         }, 10000);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = async () => {
                            const base64Audio = reader.result.split(',')[1];
                            state.attemptsUsed++;
                            await processAudio(base64Audio, referenceText, feedback, btn);
                        };
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();

                } catch (err) {
                    console.error("Mic Error:", err);
                    feedback.innerText = "Erreur micro.";
                    btn.disabled = false;
                    btn.innerHTML = `<i class="ph ph-microphone icon-fluid-lg"></i>`;
                }
            } else {
                stopRecording(btn);
            }
        };
    }

    function stopRecording(btn, force = false) {
        if (recordingTimeout) clearTimeout(recordingTimeout);
        
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        isRecording = false;
        
        if (btn && !force) {
            btn.classList.remove('recording-pulse', 'bg-red-500', 'text-white', 'border-red-500');
            btn.classList.add('bg-white', 'text-indigo-600', 'border-gray-100');
            btn.innerHTML = `<i class="ph ph-microphone icon-fluid-lg"></i>`;
        }
    }

    // --- Grammar Check for Quiz 13 ---
    function checkKoreanGrammar(text) {
        if (!text) return false;
        
        const endsWithYeyo = text.endsWith('예요');
        const endsWithIyeyo = text.endsWith('이에요');
        
        if (!endsWithYeyo && !endsWithIyeyo) return false;

        const jamos = Hangul.disassemble(text);
        if (jamos.length < 3) return false;

        let noun = "";
        if (endsWithYeyo) noun = text.slice(0, -2); 
        else noun = text.slice(0, -3); 
        
        if (!noun) return false;
        if (!text.startsWith("저는")) return false; 
        
        const lastChar = noun[noun.length - 1];
        const hasPatchim = Hangul.endsWithConsonant(lastChar);
        
        if (endsWithYeyo) {
            if (!hasPatchim) return true;
        } else if (endsWithIyeyo) {
             if (hasPatchim) return true;
        }
        
        return false;
    }

    async function processAudio(audioBase64, referenceText, feedbackEl, btnEl, forceFail = false) {
        if (!forceFail) feedbackEl.innerText = "Analyse...";
        
        let result = { text: "" };
        let score = 0;
        let passed = false;

        try {
            if (!forceFail && audioBase64) {
                const payload = { audioBase64: audioBase64, languageCode: "Kor" };
                if (referenceText) payload.referenceText = referenceText;

                const res = await fetch(CLOVA_API_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("API Error");
                result = await res.json();
                score = result.assessment?.pronunciation_score;
            }

            const recognizedText = result.text || "";
            const page = pages[currentPage];
            const displayScore = score !== undefined ? score : '-';

            // --- Validation Logic ---
            if (!forceFail) {
                if (page.type === 'conversation_reply') {
                    passed = checkKoreanGrammar(recognizedText);
                } else if (referenceText) { 
                    // Normalize and Compare
                    const normalize = (str) => str ? str.replace(/[\s\.\,\?\!]/g, "") : "";
                    const scorePass = score >= 80;
                    const textPass = recognizedText && normalize(recognizedText) === normalize(referenceText);
                    if (scorePass && textPass) passed = true; 
                } else { 
                    if (recognizedText || score >= 0) passed = true; 
                }
            }

            const state = pageStates[currentPage];
            let msg = "";

            if (passed) {
                state.passed = true;
                playSound('correct'); 
                const scoreText = page.type === 'conversation_reply' ? '' : ` (${displayScore})`;
                msg = `<span class="text-green-500 font-bold block mb-1">Excellent !${scoreText}</span>`;
                if(btnEl) {
                    btnEl.disabled = true;
                    btnEl.innerHTML = `<i class="ph ph-check icon-fluid-md text-green-500"></i>`;
                }
                resetNextButton();

                if (page.type === 'conversation_start') {
                    const replyContainer = document.getElementById('reply-container');
                    if(replyContainer) replyContainer.classList.remove('hidden');
                    if(page.replyAudio) setTimeout(() => { playAudio(page.replyAudio); }, 500);
                }

            } else {
                if (state.attemptsUsed >= (page.attempts || 3) || forceFail) {
                     msg = `<span class="text-orange-500 block mb-1">Nombre de tentatives épuisé.</span>`;
                     resetNextButton();
                } else {
                     msg = `<span class="text-orange-500 block mb-1">Réessayez. (${displayScore})</span>`;
                }
            }
            
            if (recognizedText) {
                msg += `<div class="text-indigo-600 font-medium mt-1 text-sm">"${recognizedText}"</div>`;
            }

            // Hint Logic (Not for Shadowing/Repeat pages which already have buttons)
            const isShadowing = page.type === 'shadowing';
            
            if ((!passed || forceFail) && page.audioPrompt && !isShadowing) {
                 window.playHint = () => playAudio(page.audioPrompt);
                 msg += `<button onclick="playHint()" class="mt-2 flex items-center gap-1 px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs hover:bg-yellow-200 mx-auto transition"><i class="ph ph-speaker-high"></i> Réécouter</button>`;
            }

            // Quiz 12 (Conv Start) Special: Show Reply Card
            if (page.type === 'conversation_start' && (passed || state.attemptsUsed >= 3)) {
                msg += `
                    <div class="mt-6 pt-6 border-t border-gray-100 w-full animate-fade-in">
                        <div class="flex flex-col items-center gap-3">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                                <i class="ph ph-user-circle text-2xl"></i>
                            </div>
                            <button onclick="playAudio('${page.replyAudio}')" class="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded-2xl hover:bg-gray-200 transition text-gray-800 font-bold text-lg korean-text shadow-sm">
                                <i class="ph ph-speaker-high text-indigo-500"></i>
                                ${page.replyText}
                            </button>
                        </div>
                    </div>
                `;
            }

            feedbackEl.innerHTML = msg;

        } catch (e) {
            console.error(e);
            feedbackEl.innerText = "API Error";
            // Allow retry on API error
            if(btnEl) btnEl.disabled = false; 
        }
    }

    renderPage();
</script>
</body>
</html>
